<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quality Tracker Dashboard</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
      :root {
        /* Modern, vibrant color palette */
        --primary: #4361ee;
        --primary-light: #4895ef;
        --primary-dark: #3f37c9;
        --secondary: #272640;
        --success: #4cc9f0;
        --warning: #f72585;
        --danger: #ff4d6d;
        --light: #f8f9fa;
        --dark: #212529;
        --gray: #6c757d;
        --gray-light: #e9ecef;
        --white: #ffffff;
        --gradient-accent: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);

        /* Location group colors - more vibrant and distinct */
        --location-lines: #fffbeb;
        --location-cz: #e0f2fe;
        --location-cr: #ecfdf5;
        --location-areas: #f3e8ff;
        --location-other: #fff1f2;
        --location-forms: #f0fdf4;
        
        /* Shadows */
        --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        
        /* Transitions */
        --transition-normal: all 0.3s ease;
        --transition-fast: all 0.15s ease;
        
        /* Border Radius */
        --radius-sm: 0.25rem;
        --radius-md: 0.5rem;
        --radius-lg: 1rem;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        background: var(--light);
        color: var(--dark);
        padding: 0;
        line-height: 1.5;
        transition: var(--transition-normal);
      }

      .dashboard-container {
        max-width: 1400px;
        margin: 0 auto;
        background: var(--white);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-md);
        overflow: hidden;
        transition: var(--transition-normal);
      }
      
      .fullscreen-mode {
        padding: 0;
        background: var(--white);
      }
      
      .fullscreen-mode .dashboard-container {
        max-width: 100%;
        height: 100vh;
        border-radius: 0;
        margin: 0;
      }

      header {
        background: var(--gradient-accent);
        color: var(--white);
        text-align: center;
        padding: 1.5rem;
        position: relative;
        box-shadow: var(--shadow-md);
      }

      .dashboard-title {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.75rem;
      }

      h1 {
        font-size: 1.8rem;
        margin: 0;
        letter-spacing: -0.02em;
        font-weight: 700;
      }

      .last-updated {
        position: absolute;
        top: 1rem;
        right: 1rem;
        font-size: 0.8rem;
        opacity: 0.9;
        background: rgba(255, 255, 255, 0.2);
        padding: 0.4rem 0.8rem;
        border-radius: var(--radius-md);
        backdrop-filter: blur(4px);
      }
      
      .fullscreen-btn {
        position: absolute;
        top: 1rem;
        left: 1rem;
        background: rgba(255, 255, 255, 0.2);
        color: var(--white);
        border: none;
        border-radius: var(--radius-md);
        padding: 0.5rem 1rem;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        transition: var(--transition-fast);
        backdrop-filter: blur(4px);
      }
      
      .fullscreen-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: translateY(-1px);
      }
      
      .cycling-indicator {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: var(--primary-dark);
        color: white;
        padding: 10px 15px;
        border-radius: 20px;
        z-index: 1000;
        display: none;
        box-shadow: var(--shadow-lg);
        animation: pulse 2s infinite;
      }
      
      @keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(67, 97, 238, 0.7); }
        70% { box-shadow: 0 0 0 10px rgba(67, 97, 238, 0); }
        100% { box-shadow: 0 0 0 0 rgba(67, 97, 238, 0); }
      }

      .dashboard-overview {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
        padding: 1.5rem;
        background: var(--white);
      }

      .stat-card {
        background: var(--white);
        border-radius: var(--radius-md);
        padding: 1.25rem;
        text-align: center;
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--gray-light);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        transition: var(--transition-fast);
      }
      
      .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
      }

      .stat-icon {
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
        background: var(--primary-light);
        color: var(--white);
        width: 3rem;
        height: 3rem;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .stat-number {
        font-size: 2.25rem;
        font-weight: 700;
        color: var(--primary);
        margin-bottom: 0.25rem;
      }

      .stat-label {
        font-size: 0.9rem;
        color: var(--gray);
        font-weight: 500;
      }

      .dashboard-content {
        display: grid;
        grid-template-columns: 1fr;
        gap: 2rem;
        padding: 0.5rem 1.5rem 2rem;
      }

      .section {
        background: var(--white);
        border-radius: var(--radius-md);
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--gray-light);
        overflow: hidden;
        transition: var(--transition-normal);
      }
      
      .section.inactive {
        display: none;
      }

      .section-header {
        background: var(--white);
        padding: 1rem 1.5rem;
        border-bottom: 1px solid var(--gray-light);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 10px;
      }

      .section-title {
        font-size: 1.2rem;
        color: var(--dark);
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }
      
      .section-title i {
        color: var(--primary);
      }

      .controls-container {
        display: flex;
        gap: 1rem;
        align-items: center;
        flex-wrap: wrap;
      }

      .loading {
        text-align: center;
        padding: 3rem 1rem;
        color: var(--gray);
        font-style: italic;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 1rem;
      }
      
      .loading-spinner {
        width: 2.5rem;
        height: 2.5rem;
        border: 3px solid var(--gray-light);
        border-top: 3px solid var(--primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      /* Table container with fixed header */
      .table-container {
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .table-header {
        background-color: var(--primary);
        position: sticky;
        top: 0;
        z-index: 10;
        width: 100%;
      }
      
      .table-body {
        overflow-y: auto;
        max-height: 400px;
        width: 100%;
      }
      
      .fullscreen-mode .table-body {
        max-height: calc(100vh - 280px);
      }
      
      /* Table styling */
      .responsive-table {
        width: 100%;
        border-spacing: 0;
        font-size: 0.9rem;
      }
      
      .responsive-table th {
        background-color: var(--primary);
        color: var(--white);
        padding: 0.9rem 1rem;
        text-align: left;
        font-weight: 600;
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        white-space: nowrap;
        position: relative;
      }
      
      .responsive-table th:not(:last-child):after {
        content: "";
        position: absolute;
        right: 0;
        top: 30%;
        height: 40%;
        width: 1px;
        background-color: rgba(255,255,255,0.3);
      }
      
      .responsive-table td {
        padding: 1rem;
        border-bottom: 1px solid var(--gray-light);
        transition: var(--transition-fast);
      }
      
      .responsive-table tr:hover td {
        background-color: rgba(0,0,0,0.01);
      }
      
      .responsive-table tr:last-child td {
        border-bottom: none;
      }

      /* Location group styling - subtle background colors */
      .location-lines td {
        background-color: var(--location-lines);
      }

      .location-cz td {
        background-color: var(--location-cz);
      }

      .location-cr td {
        background-color: var(--location-cr);
      }

      .location-areas td {
        background-color: var(--location-areas);
      }

      .location-other td {
        background-color: var(--location-other);
      }
      
      .location-forms td {
        background-color: var(--location-forms);
      }

      /* Status indicators */
      .status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        position: relative;
      }
      
      .status-indicator:after {
        content: '';
        position: absolute;
        top: -4px;
        left: -4px;
        right: -4px;
        bottom: -4px;
        border-radius: 50%;
        animation: pulse-ring 2s ease infinite;
        opacity: 0.5;
      }

      .status-good {
        background-color: var(--success);
      }
      
      .status-good:after {
        animation: none;
      }

      .status-warning {
        background-color: #f59e0b;
      }
      
      .status-warning:after {
        background-color: rgba(245, 158, 11, 0.3);
      }

      .status-critical {
        background-color: var(--warning);
      }
      
      .status-critical:after {
        background-color: rgba(247, 37, 133, 0.3);
      }
      
      @keyframes pulse-ring {
        0% { transform: scale(0.95); opacity: 0.7; }
        50% { transform: scale(1.2); opacity: 0.3; }
        100% { transform: scale(0.95); opacity: 0.7; }
      }

      .notif-indicator {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        color: var(--white);
        font-weight: 600;
        margin: 0 auto;
        font-size: 0.8rem;
      }

      .notif-active {
        background-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
      }

      .notif-inactive {
        background-color: #e0e0e0;
        color: #9e9e9e;
      }

      .warning-badge {
        display: inline-block;
        padding: 0.35rem 0.6rem;
        border-radius: var(--radius-sm);
        font-size: 0.75rem;
        font-weight: 600;
        letter-spacing: 0.02em;
        text-transform: uppercase;
        background-color: #f59e0b;
        color: var(--white);
      }
      
      .warning-badge[data-type="Dev"] {
        background-color: var(--warning);
      }

      .deviation-days {
        font-weight: 600;
      }

      .days-critical {
        color: var(--warning);
      }

      .days-warning {
        color: #f59e0b;
      }

      .days-normal {
        color: var(--success);
      }

      /* Legend */
      .legend {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        padding: 1.5rem 2rem;
        background: var(--white);
        border-radius: var(--radius-md);
        margin-top: 0;
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--gray-light);
      }

      .legend-item {
        display: flex;
        align-items: center;
        font-size: 0.8rem;
      }

      .legend-color {
        width: 16px;
        height: 16px;
        border-radius: var(--radius-sm);
        margin-right: 0.5rem;
      }

      .view-toggle {
        display: flex;
        gap: 5px;
      }

      .view-btn {
        padding: 0.4rem 0.8rem;
        font-size: 0.75rem;
        border: 1px solid var(--primary);
        background-color: var(--white);
        color: var(--primary);
        border-radius: var(--radius-md);
        cursor: pointer;
        transition: var(--transition-fast);
        font-weight: 500;
      }

      .view-btn.active {
        background-color: var(--primary);
        color: var(--white);
        font-weight: 600;
      }

      .view-btn:hover:not(.active) {
        background-color: rgba(67, 97, 238, 0.1);
      }

      .text-center {
        text-align: center;
      }
      
      .sortable {
        cursor: pointer;
        user-select: none;
      }
      
      .sortable:hover {
        background-color: var(--primary-dark);
      }
      
      .sortable::after {
        content: "⇵";
        margin-left: 5px;
        opacity: 0.7;
        font-size: 0.8rem;
      }
      
      .sortable.sorted-asc::after {
        content: "↑";
      }
      
      .sortable.sorted-desc::after {
        content: "↓";
      }
      
      /* Empty state styling */
      .empty-state {
        text-align: center;
        padding: 3rem 1rem;
        color: var(--gray);
      }
      
      .empty-state-icon {
        font-size: 2.5rem;
        color: var(--gray-light);
        margin-bottom: 1rem;
      }
      
      /* Location filter styling */
      .location-filter {
        position: relative;
      }
      
      .location-filter select {
        padding: 0.4rem 2rem 0.4rem 0.8rem;
        font-size: 0.85rem;
        border: 1px solid var(--primary);
        border-radius: var(--radius-md);
        background-color: var(--white);
        color: var(--primary);
        font-weight: 500;
        cursor: pointer;
        appearance: none;
        width: 100%;
        min-width: 150px;
      }
      
      .location-filter::after {
        content: "▼";
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--primary);
        font-size: 0.7rem;
        pointer-events: none;
      }
      
      /* Pagination controls */
      .pagination-controls {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem;
        border-top: 1px solid var(--gray-light);
      }
      
      .page-indicator {
        font-size: 0.9rem;
        color: var(--gray);
      }
      
      .pagination-btn {
        background: var(--white);
        border: 1px solid var(--gray-light);
        border-radius: var(--radius-sm);
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: var(--transition-fast);
      }
      
      .pagination-btn:hover:not(:disabled) {
        background: var(--primary-light);
        color: var(--white);
        border-color: var(--primary-light);
      }
      
      .pagination-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      
      /* Responsive adjustments */
      @media (max-width: 768px) {
        .dashboard-overview {
          grid-template-columns: 1fr;
        }
        
        .responsive-table {
          font-size: 0.85rem;
        }
        
        .responsive-table th, 
        .responsive-table td {
          padding: 0.75rem 0.5rem;
        }
        
        .dashboard-content,
        .dashboard-overview {
          padding: 1rem;
        }
        
        .legend {
          padding: 1rem;
        }
        
        .view-toggle {
          flex-direction: column;
        }
        
        .section-header {
          flex-direction: column;
          align-items: flex-start;
        }
        
        .controls-container {
          width: 100%;
          justify-content: space-between;
        }
      }
    </style>
  </head>
  <body>
    <div class="dashboard-container">
      <header>
        <button id="fullscreenBtn" class="fullscreen-btn"><i class="fas fa-expand"></i> Fullscreen Mode</button>
        <div class="dashboard-title">
          <i class="fas fa-chart-line"></i>
          <h1>Quality Tracker Dashboard</h1>
        </div>
        <div class="last-updated" id="lastUpdated">Last updated: Loading...</div>
      </header>

      <div class="dashboard-overview">
        <div class="stat-card">
          <div class="stat-icon"><i class="fas fa-exclamation-circle"></i></div>
          <div class="stat-number" id="totalIssuesCount">-</div>
          <div class="stat-label">Active Issues</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon"><i class="fas fa-file-contract"></i></div>
          <div class="stat-number" id="deviationsCount">-</div>
          <div class="stat-label">Open Deviations</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon"><i class="fas fa-map-marker-alt"></i></div>
          <div class="stat-number" id="locationsCount">-</div>
          <div class="stat-label">Affected Locations</div>
        </div>
      </div>

      <div class="dashboard-content">
        <!-- Notifications Section -->
        <div class="section">
          <div class="section-header">
            <h2 class="section-title">
              <i class="fas fa-bell"></i>
              Current Notifications
            </h2>
            <div class="controls-container">
              <div class="location-filter">
                <select id="notificationsLocationFilter">
                  <option value="all">All Locations</option>
                  <!-- Options will be populated dynamically -->
                </select>
              </div>
              <div class="view-toggle">
                <button id="viewFilteredBtn" class="view-btn active">Show Critical (3+)</button>
                <button id="viewAllBtn" class="view-btn">Show All</button>
              </div>
            </div>
          </div>
          <div id="loadingNotifications" class="loading">
            <div class="loading-spinner"></div>
            <div>Loading notifications data...</div>
          </div>
          <div id="notificationsTableContainer" class="table-container" style="display: none;"></div>
        </div>

        <!-- Deviations Section -->
        <div class="section">
          <div class="section-header">
            <h2 class="section-title">
              <i class="fas fa-exclamation-triangle"></i>
              Open Deviations
            </h2>
            <div class="controls-container">
              <div class="location-filter">
                <select id="deviationsLocationFilter">
                  <option value="all">All Locations</option>
                  <!-- Options will be populated dynamically -->
                </select>
              </div>
            </div>
          </div>
          <div id="loadingDeviations" class="loading">
            <div class="loading-spinner"></div>
            <div>Loading deviations data...</div>
          </div>
          <div id="deviationsTableContainer" class="table-container" style="display: none;"></div>
        </div>

        <!-- Legend -->
        <div class="legend">
          <div class="legend-item">
            <div class="legend-color" style="background-color: var(--location-lines);"></div>
            <span>Production Lines (SCD, SUM, LEVO, SCALPEL, POPUP, XL2000/UBT)</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background-color: var(--location-cz);"></div>
            <span>Change Zone (CZ)</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background-color: var(--location-cr);"></div>
            <span>Clean Room (CR)</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background-color: var(--location-areas);"></div>
            <span>General Areas (PO, PA, MH)</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background-color: var(--location-other);"></div>
            <span>Other Locations</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background-color: var(--location-forms);"></div>
            <span>Forms & Registers</span>
          </div>
        </div>
      </div>
      
      <div id="cyclingIndicator" class="cycling-indicator">Auto-cycling content...</div>
    </div>

    <script>
      // Function to define all check-location pairs for complete coverage
      function addAllChecks() {
        // This array contains all Check-Location pairs that should be tracked
        // Format: [Check, Location]
        return [
          // Production Lines
          // SCD
          ["Overfilling of Feeders", "SCD"],
          ["Components on the floor", "SCD"],
          ["Build-up of subassemblies", "SCD"],
          ["Cluttered workspaces", "SCD"],
          ["Incorrect utilization of containers", "SCD"],
          ["Rework done on the production line", "SCD"],
          ["Cleaning", "SCD"],
          ["More than one component in a bin/container/feeder", "SCD"],
          ["Clear seperation of tested and untested components", "SCD"],
          ["Inadequate or dirty PPE Usage", "SCD"],
          
          // SUM
          ["Overfilling of Feeders", "SUM"],
          ["Components on the floor", "SUM"],
          ["Build-up of subassemblies", "SUM"],
          ["Cluttered workspaces", "SUM"],
          ["Incorrect utilization of containers", "SUM"],
          ["Rework done on the production line", "SUM"],
          ["Cleaning", "SUM"],
          ["More than one component in a bin/container/feeder", "SUM"],
          ["Clear seperation of tested and untested components", "SUM"],
          ["Inadequate or dirty PPE Usage", "SUM"],
          
          // LEVO
          ["Overfilling of Feeders", "LEVO"],
          ["Components on the floor", "LEVO"],
          ["Build-up of subassemblies", "LEVO"],
          ["Cluttered workspaces", "LEVO"],
          ["Incorrect utilization of containers", "LEVO"],
          ["Rework done on the production line", "LEVO"],
          ["Cleaning", "LEVO"],
          ["More than one component in a bin/container/feeder", "LEVO"],
          ["Clear seperation of tested and untested components", "LEVO"],
          ["Inadequate or dirty PPE Usage", "LEVO"],
          
          // SCALPEL
          ["Overfilling of Feeders", "SCALPEL"],
          ["Components on the floor", "SCALPEL"],
          ["Build-up of subassemblies", "SCALPEL"],
          ["Cluttered workspaces", "SCALPEL"],
          ["Incorrect utilization of containers", "SCALPEL"],
          ["Rework done on the production line", "SCALPEL"],
          ["Cleaning", "SCALPEL"],
          ["More than one component in a bin/container/feeder", "SCALPEL"],
          ["Clear seperation of tested and untested components", "SCALPEL"],
          ["Inadequate or dirty PPE Usage", "SCALPEL"],
          
          // POPUP
          ["Overfilling of Feeders", "POPUP"],
          ["Components on the floor", "POPUP"],
          ["Build-up of subassemblies", "POPUP"],
          ["Cluttered workspaces", "POPUP"],
          ["Incorrect utilization of containers", "POPUP"],
          ["Rework done on the production line", "POPUP"],
          ["Cleaning", "POPUP"],
          ["More than one component in a bin/container/feeder", "POPUP"],
          ["Clear seperation of tested and untested components", "POPUP"],
          
          // XL2000/UBT
          ["Overfilling of Feeders", "XL2000/UBT"],
          ["Components on the floor", "XL2000/UBT"],
          ["Build-up of subassemblies", "XL2000/UBT"],
          ["Cluttered workspaces", "XL2000/UBT"],
          ["Incorrect utilization of containers", "XL2000/UBT"],
          ["Rework done on the production line", "XL2000/UBT"],
          ["Cleaning", "XL2000/UBT"],
          ["More than one component in a bin/container/feeder", "XL2000/UBT"],
          ["Clear seperation of tested and untested components", "XL2000/UBT"],
          
          // Areas
          ["Maglocks Not Working", "PO"],
          ["Maglocks Not Working", "PA"],
          ["Maglocks Not Working", "MH"],
          ["Maglocks Not Working", "CZ"],
          ["Hand Soap and Sanitisers Empty", "CZ"],
          ["Hand Soap and Sanitisers Empty", "PO"],
          ["Contaminated Floor Mats", "CR"],
          ["Contaminated Floor Mats", "CZ"],
          ["Contaminated Floor Mats", "PO"],
          
          // Clean Room
          ["Manometer Readings out of Spec: Pressure Differential below 5Pa", "CR"],
          ["Temperature Readings out of Spec: Out of 18-26 deg C range", "CR"],
          ["Air Conditioning Not Maintained at Specified temperatures: 22deg C and cool", "CR"],
          ["AHU Not Functioning: Air Handling unit switched 1 hour before production starts", "CR"],
          ["AHU Not Functioning: Unit only switched off when production is done for the week", "CR"],
          ["Microbial Control in the CR Not maintained based on test results from independant laboratory", "CR"],
          
          // Change Zone
          ["Temperature Readings out of Spec: Out of 18-26 deg C range", "CZ"],
          ["Air Conditioning Not Maintained at Specified temperatures: 22deg C and cool", "CZ"],
          ["AHU Not Functioning: Air Handling unit switched 1 hour before production starts", "CZ"],
          ["AHU Not Functioning: Unit only switched off when production is done for the week", "CZ"],
          ["Cleaning", "CZ"],
          
          // Forms and registers
          ["Maglock Checks", "MF45 REV 00"],
          ["Mat cleaning and solution", "MF49 REV 02"],
          ["Cleaning Checklist", "MF02 REV 09"],
          ["Deep Cleaning Register", "MF54 REV 01"],
          ["Dust Coat Weekly Inspection Register", "MF55 REV 02"],
          ["Glove Issue Register", "MF03 REV 00"],
          ["PPE Register", "MF53 REV 00"],
          ["Earplug Register", "MF91 REV 00"]
        ];
      }

      // Utility functions
      function getLocationGroup(location) {
        // Production line locations (prioritized)
        if (['SCD', 'SUM', 'LEVO', 'Scalpel', 'SCALPEL', 'POPUP', 'XL2000/UBT'].includes(location)) {
          return 'location-lines';
        }
        // Change zone location
        else if (location === 'CZ') {
          return 'location-cz';
        }
        // Clean room location
        else if (location === 'CR') {
          return 'location-cr';
        }
        // Area locations
        else if (['PO', 'PA', 'MH', 'Warehouse', 'Quality'].includes(location)) {
          return 'location-areas';
        }
        // Forms and Registers
        else if (location.includes('REV') || location.startsWith('MF')) {
          return 'location-forms';
        }
        // Default for other locations
        else {
          return 'location-other';
        }
      }

      // Get status based on notification count or days remaining
      function getNotificationStatus(notifCount, hasWarning) {
        if (hasWarning) {
          return 'status-critical';
        } else if (notifCount >= 3) {
          return 'status-warning';
        } else {
          return 'status-good';
        }
      }

      function getDeviationStatus(daysRemaining) {
        if (daysRemaining <= 3) {
          return 'status-critical';
        } else if (daysRemaining <= 7) {
          return 'status-warning';
        } else {
          return 'status-good';
        }
      }

      function getDaysClass(daysRemaining) {
        if (daysRemaining <= 3) {
          return 'days-critical';
        } else if (daysRemaining <= 7) {
          return 'days-warning';
        } else {
          return 'days-normal';
        }
      }

      // Sort functions - works with split table structure
      function sortTable(tableId, column, asc = true) {
        // Get the table body element to sort
        const tableContainerId = tableId === 'notificationsTable' ? 
          'notificationsTableContainer' : 'deviationsTableContainer';
        const tableBody = document.querySelector(`#${tableContainerId} .table-body tbody`);
        
        if (!tableBody) return;
        
        const rows = Array.from(tableBody.querySelectorAll('tr'));
        
        // Sort based on the selected column
        const sortedRows = rows.sort((a, b) => {
          const aValue = a.querySelector(`td[data-sort="${column}"]`)?.getAttribute('data-value') || '';
          const bValue = b.querySelector(`td[data-sort="${column}"]`)?.getAttribute('data-value') || '';
          
          if (!isNaN(aValue) && !isNaN(bValue)) {
            return asc ? aValue - bValue : bValue - aValue;
          } else {
            return asc ? aValue.localeCompare(bValue) : bValue.localeCompare(aValue);
          }
        });
        
        // Clear table and add sorted rows
        tableBody.innerHTML = '';
        sortedRows.forEach(row => tableBody.appendChild(row));
      }

      // Attach event listeners to sortable headers
      function setupSorting() {
        document.querySelectorAll('.sortable').forEach(header => {
          header.addEventListener('click', function() {
            const column = this.getAttribute('data-sort');
            const tableId = this.closest('.table-header').parentNode.id === 'notificationsTableContainer' ? 
              'notificationsTable' : 'deviationsTable';
            const asc = this.classList.contains('sorted-asc') ? false : true;
            
            // Reset all headers
            document.querySelectorAll('.sortable').forEach(h => {
              h.classList.remove('sorted-asc', 'sorted-desc');
            });
            
            // Set sort indicator
            this.classList.add(asc ? 'sorted-asc' : 'sorted-desc');
            
            sortTable(tableId, column, asc);
          });
        });
      }
      
      // Update dashboard stats based on current view
      function updateStats() {
        const data = window.dashboardData;
        if (!data) return;
        
        // Get the filtered data based on current filters
        const notifLocation = document.getElementById('notificationsLocationFilter').value;
        const devLocation = document.getElementById('deviationsLocationFilter').value;
        
        let notificationsData;
        if (document.getElementById('viewFilteredBtn').classList.contains('active')) {
          notificationsData = window.dashboardData.criticalNotifications;
        } else {
          notificationsData = window.dashboardData.allNotifications;
        }
        
        // Apply location filter to notifications
        if (notifLocation !== 'all') {
          notificationsData = notificationsData.filter(row => row.location === notifLocation);
        }
        
        // Apply location filter to deviations
        let deviationsData = window.dashboardData.deviations;
        if (devLocation !== 'all') {
          deviationsData = deviationsData.filter(row => row.location === devLocation);
        }
        
        // Update counts
        document.getElementById("totalIssuesCount").innerText = notificationsData.length + deviationsData.length;
        document.getElementById("deviationsCount").innerText = deviationsData.length;
        
        // Count unique locations from both filtered datasets
        const uniqueLocationsSet = new Set();
        notificationsData.forEach(row => uniqueLocationsSet.add(row.location));
        deviationsData.forEach(row => uniqueLocationsSet.add(row.location));
        document.getElementById("locationsCount").innerText = uniqueLocationsSet.size;
      }

      // Table pagination functions
      function setupPagination(tableContainer, rowsPerPage = 20) {
        const tableBody = tableContainer.querySelector('.table-body');
        const rows = tableBody.querySelectorAll('tbody tr');
        
        // If no rows or empty state, no pagination needed
        if (rows.length <= 1 && rows[0]?.querySelector('.empty-state')) {
          return;
        }
        
        // If fewer rows than rowsPerPage, no pagination needed
        if (rows.length <= rowsPerPage) {
          return;
        }
        
        const totalPages = Math.ceil(rows.length / rowsPerPage);
        let currentPage = 1;
        
        // Create pagination controls
        const paginationControls = document.createElement('div');
        paginationControls.className = 'pagination-controls';
        paginationControls.innerHTML = `
          <button class="pagination-btn prev-page" disabled>
            <i class="fas fa-chevron-left"></i>
          </button>
          <span class="page-indicator">Page <span class="current-page">1</span> of <span class="total-pages">${totalPages}</span></span>
          <button class="pagination-btn next-page">
            <i class="fas fa-chevron-right"></i>
          </button>
        `;
        
        tableContainer.appendChild(paginationControls);
        
        // Function to show the current page
        function showPage(page) {
          // Hide all rows
          rows.forEach(row => row.style.display = 'none');
          
          // Show rows for current page
          const startIndex = (page - 1) * rowsPerPage;
          const endIndex = Math.min(startIndex + rowsPerPage, rows.length);
          
          for (let i = startIndex; i < endIndex; i++) {
            rows[i].style.display = '';
          }
          
          // Update pagination controls
          paginationControls.querySelector('.current-page').textContent = page;
          paginationControls.querySelector('.prev-page').disabled = page === 1;
          paginationControls.querySelector('.next-page').disabled = page === totalPages;
          
          // Scroll to top of table body
          tableBody.scrollTop = 0;
          
          // Update current page
          currentPage = page;
        }
        
        // Add event listeners to pagination buttons
        paginationControls.querySelector('.prev-page').addEventListener('click', () => {
          if (currentPage > 1) {
            showPage(currentPage - 1);
          }
        });
        
        paginationControls.querySelector('.next-page').addEventListener('click', () => {
          if (currentPage < totalPages) {
            showPage(currentPage + 1);
          }
        });
        
        // Show first page initially
        showPage(1);
        
        // Return pagination control functions
        return {
          totalPages,
          showPage,
          getCurrentPage: () => currentPage
        };
      }

      // Fullscreen and cycling functionality
      let isFullscreen = false;
      let cyclingInterval = null;
      let cyclingTimeout = null;
      
      function toggleFullscreen() {
        isFullscreen = !isFullscreen;
        
        if (isFullscreen) {
          // Enter fullscreen
          document.body.classList.add('fullscreen-mode');
          document.getElementById('fullscreenBtn').innerHTML = '<i class="fas fa-compress"></i> Exit Fullscreen';
          
          // Start auto-cycling
          startContentCycling();
          
          // Request browser fullscreen
          if (document.documentElement.requestFullscreen) {
            document.documentElement.requestFullscreen();
          } else if (document.documentElement.webkitRequestFullscreen) {
            document.documentElement.webkitRequestFullscreen();
          } else if (document.documentElement.msRequestFullscreen) {
            document.documentElement.msRequestFullscreen();
          }
        } else {
          // Exit fullscreen
          document.body.classList.remove('fullscreen-mode');
          document.getElementById('fullscreenBtn').innerHTML = '<i class="fas fa-expand"></i> Fullscreen Mode';
          
          // Stop auto-cycling
          stopContentCycling();
          
          // Exit browser fullscreen only if we're currently in fullscreen mode
          if (document.fullscreenElement || 
              document.webkitFullscreenElement || 
              document.msFullscreenElement) {
            
            try {
              if (document.exitFullscreen) {
                document.exitFullscreen();
              } else if (document.webkitExitFullscreen) {
                document.webkitExitFullscreen();
              } else if (document.msExitFullscreen) {
                document.msExitFullscreen();
              }
            } catch (error) {
              console.error("Error exiting fullscreen:", error);
            }
          }
        }
      }
      
      // Completely redone cycling logic to handle tables better
      function startContentCycling() {
        // Get all sections and their pagination controls
        const sections = [
          {
            name: "Notifications",
            element: document.querySelector('.section:nth-child(1)'),
            container: document.getElementById('notificationsTableContainer'),
            pagination: null
          },
          {
            name: "Deviations",
            element: document.querySelector('.section:nth-child(2)'),
            container: document.getElementById('deviationsTableContainer'),
            pagination: null
          }
        ];
        
        // Set up pagination controls for each section if they exist
        sections.forEach(section => {
          if (section.container) {
            // Check if pagination controls already exist
            const existingControls = section.container.querySelector('.pagination-controls');
            if (existingControls) {
              // Extract pagination information
              const totalPages = parseInt(existingControls.querySelector('.total-pages').textContent);
              const currentPage = parseInt(existingControls.querySelector('.current-page').textContent);
              
              // Store pagination info
              section.pagination = {
                totalPages,
                currentPage,
                showPage: (page) => {
                  // Simulate clicking next/prev until we reach the target page
                  const currentPage = parseInt(existingControls.querySelector('.current-page').textContent);
                  if (page > currentPage) {
                    for (let i = currentPage; i < page; i++) {
                      existingControls.querySelector('.next-page').click();
                    }
                  } else if (page < currentPage) {
                    for (let i = currentPage; i > page; i--) {
                      existingControls.querySelector('.prev-page').click();
                    }
                  }
                }
              };
            }
          }
        });
        
        let currentSectionIndex = 0;
        let currentPageIndex = 0;
        const pageDisplayDuration = 15000; // 15 seconds per page
        
        // Create cycling indicator
        const cyclingIndicator = document.getElementById('cyclingIndicator');
        cyclingIndicator.style.display = 'block';
        
        // Function to show specific section and page
        function showSectionAndPage(sectionIndex, pageIndex) {
          // Hide all sections
          sections.forEach(section => {
            section.element.classList.add('inactive');
          });
          
          // Show current section
          const currentSection = sections[sectionIndex];
          currentSection.element.classList.remove('inactive');
          
          // If section has pagination, show the correct page
          if (currentSection.pagination && currentSection.pagination.totalPages > 0) {
            const targetPage = (pageIndex % currentSection.pagination.totalPages) + 1;
            currentSection.pagination.showPage(targetPage);
            
            // Update cycling indicator
            cyclingIndicator.textContent = `Auto-cycling: ${currentSection.name} (Page ${targetPage}/${currentSection.pagination.totalPages})`;
          } else {
            // Just show the section without pagination
            cyclingIndicator.textContent = `Auto-cycling: ${currentSection.name}`;
          }
          
          // Scroll to top of section
          const tableBody = currentSection.container.querySelector('.table-body');
          if (tableBody) tableBody.scrollTop = 0;
        }
        
        // Function to advance to next page or section
        function advanceCycling() {
          const currentSection = sections[currentSectionIndex];
          
          // If current section has pagination and we're not on the last page
          if (currentSection.pagination && 
              currentPageIndex < currentSection.pagination.totalPages - 1) {
            // Move to next page
            currentPageIndex++;
          } else {
            // Move to next section
            currentSectionIndex = (currentSectionIndex + 1) % sections.length;
            currentPageIndex = 0;
          }
          
          // Show the new section and page
          showSectionAndPage(currentSectionIndex, currentPageIndex);
          
          // Schedule next page change
          cyclingTimeout = setTimeout(advanceCycling, pageDisplayDuration);
        }
        
        // Start cycling
        showSectionAndPage(currentSectionIndex, currentPageIndex);
        cyclingTimeout = setTimeout(advanceCycling, pageDisplayDuration);
      }
      
      function stopContentCycling() {
        // Clear any existing timeouts
        if (cyclingTimeout) {
          clearTimeout(cyclingTimeout);
          cyclingTimeout = null;
        }
        
        // Remove inactive class from all sections
        document.querySelectorAll('.section').forEach(section => {
          section.classList.remove('inactive');
        });
        
        // Hide cycling indicator
        document.getElementById('cyclingIndicator').style.display = 'none';
      }
      
      // Table rendering functions - updated to support location filtering and pagination
      function renderNotificationsTable(rows) {
        // Completely rebuild the table container structure
        const tableContainer = document.getElementById("notificationsTableContainer");
        tableContainer.innerHTML = '';
        
        // Create the fixed header section
        const headerSection = document.createElement("div");
        headerSection.className = "table-header";
        
        const headerTable = document.createElement("table");
        headerTable.className = "responsive-table";
        headerTable.innerHTML = `
          <thead>
            <tr>
              <th class="sortable" data-sort="check">Check</th>
              <th class="sortable" data-sort="location">Location</th>
              <th>Notif 1</th>
              <th>Notif 2</th>
              <th>Notif 3</th>
              <th>Warning</th>
              <th>Previous</th>
              <th>Status</th>
            </tr>
          </thead>
        `;
        headerSection.appendChild(headerTable);
        tableContainer.appendChild(headerSection);
        
        // Create the scrollable body section
        const bodySection = document.createElement("div");
        bodySection.className = "table-body";
        
        const bodyTable = document.createElement("table");
        bodyTable.id = "notificationsTableBody";
        bodyTable.className = "responsive-table";
        
        // Create an empty body
        const tbody = document.createElement("tbody");
        bodyTable.appendChild(tbody);
        
        bodySection.appendChild(bodyTable);
        tableContainer.appendChild(bodySection);
        
        // Now populate the table
        if (!rows || rows.length === 0) {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td colspan="8" class="empty-state">
              <div class="empty-state-icon"><i class="far fa-bell-slash"></i></div>
              <div>No notifications to display.</div>
            </td>`;
          tbody.appendChild(tr);
        } else {
          rows.forEach(row => {
            const tr = document.createElement("tr");
            tr.className = row.locationGroup;
            
            // Status based on notification count and warning presence
            const statusClass = getNotificationStatus(row.notifCount, row.hasWarning);
            
            // Extract warning type for styling (Dev vs regular warning)
            const warningType = row.warning && row.warning.startsWith('Dev') ? 'Dev' : '';
            
            tr.innerHTML = `
              <td data-sort="check" data-value="${row.check}">${row.check}</td>
              <td data-sort="location" data-value="${row.location}">${row.location}</td>
              <td class="text-center">
                <div class="notif-indicator ${row.notif1 ? 'notif-active' : 'notif-inactive'}">1</div>
              </td>
              <td class="text-center">
                <div class="notif-indicator ${row.notif2 ? 'notif-active' : 'notif-inactive'}">2</div>
              </td>
              <td class="text-center">
                <div class="notif-indicator ${row.notif3 ? 'notif-active' : 'notif-inactive'}">3</div>
              </td>
              <td>
                ${row.warning ? `<div class="warning-badge" data-type="${warningType}">${row.warning}</div>` : ''}
              </td>
              <td>${row.totalPrevWarnings}</td>
              <td>
                <span class="status-indicator ${statusClass}"></span>
              </td>
            `;
            tbody.appendChild(tr);
          });
        }
        
        document.getElementById("loadingNotifications").style.display = "none";
        tableContainer.style.display = "flex";
        
        // Setup pagination
        setupPagination(tableContainer, 15);
      }
      
      function renderDeviationsTable(rows) {
        // Completely rebuild the table container structure
        const tableContainer = document.getElementById("deviationsTableContainer");
        tableContainer.innerHTML = '';
        
        // Create the fixed header section
        const headerSection = document.createElement("div");
        headerSection.className = "table-header";
        
        const headerTable = document.createElement("table");
        headerTable.className = "responsive-table";
        headerTable.innerHTML = `
          <thead>
            <tr>
              <th class="sortable" data-sort="check">Check</th>
              <th class="sortable" data-sort="location">Location</th>
              <th class="sortable" data-sort="daysRemaining">End Date (Days Remaining)</th>
              <th>Previous</th>
              <th>Status</th>
            </tr>
          </thead>
        `;
        headerSection.appendChild(headerTable);
        tableContainer.appendChild(headerSection);
        
        // Create the scrollable body section
        const bodySection = document.createElement("div");
        bodySection.className = "table-body";
        
        const bodyTable = document.createElement("table");
        bodyTable.id = "deviationsTableBody";
        bodyTable.className = "responsive-table";
        
        // Create an empty body
        const tbody = document.createElement("tbody");
        bodyTable.appendChild(tbody);
        
        bodySection.appendChild(bodyTable);
        tableContainer.appendChild(bodySection);
        
        // Now populate the table
        if (!rows || rows.length === 0) {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td colspan="5" class="empty-state">
              <div class="empty-state-icon"><i class="far fa-file-excel"></i></div>
              <div>No open deviations to display.</div>
            </td>`;
          tbody.appendChild(tr);
        } else {
          rows.forEach(row => {
            const tr = document.createElement("tr");
            tr.className = row.locationGroup;
            
            // Format the date as dd MMM
            const endDate = new Date(row.deviationEnd);
            const day = endDate.getDate().toString().padStart(2, '0');
            const month = endDate.toLocaleString('en-US', { month: 'short' });
            const formattedDate = `${day} ${month}`;
            
            // Status based on days remaining
            const statusClass = getDeviationStatus(row.daysRemaining);
            const daysClass = getDaysClass(row.daysRemaining);
            
            tr.innerHTML = `
              <td data-sort="check" data-value="${row.check}">${row.check}</td>
              <td data-sort="location" data-value="${row.location}">${row.location}</td>
              <td data-sort="daysRemaining" data-value="${row.daysRemaining}">
                ${formattedDate} <span class="deviation-days ${daysClass}">(${row.daysRemaining} days)</span>
              </td>
              <td>${row.totalPrevDeviations}</td>
              <td>
                <span class="status-indicator ${statusClass}"></span>
              </td>
            `;
            tbody.appendChild(tr);
          });
        }
        
        document.getElementById("loadingDeviations").style.display = "none";
        tableContainer.style.display = "flex";
        
        // Setup pagination
        setupPagination(tableContainer, 15);
      }
      
      // Populate location filters
      function populateLocationFilters(data) {
        // Create a set of all unique locations
        const uniqueLocations = new Set();
        
        // Add locations from notifications
        data.allNotifications.forEach(row => {
          uniqueLocations.add(row.location);
        });
        
        // Add locations from deviations
        data.deviations.forEach(row => {
          uniqueLocations.add(row.location);
        });
        
        // Convert to array and sort
        const locationsArray = Array.from(uniqueLocations).sort();
        
        // Populate filters
        const notifFilter = document.getElementById('notificationsLocationFilter');
        const devFilter = document.getElementById('deviationsLocationFilter');
        
        // Add options to both filters
        locationsArray.forEach(location => {
          notifFilter.innerHTML += `<option value="${location}">${location}</option>`;
          devFilter.innerHTML += `<option value="${location}">${location}</option>`;
        });
        
        // Add event listeners for filter changes
        notifFilter.addEventListener('change', function() {
          filterNotifications(this.value);
        });
        
        devFilter.addEventListener('change', function() {
          filterDeviations(this.value);
        });
      }
      
      // Filter functions
      function filterNotifications(location) {
        if (!window.dashboardData) return;
        
        // Get the base dataset based on critical/all toggle
        let filteredData;
        if (document.getElementById('viewFilteredBtn').classList.contains('active')) {
          filteredData = window.dashboardData.criticalNotifications;
        } else {
          filteredData = window.dashboardData.allNotifications;
        }
        
        // Apply location filter
        if (location !== 'all') {
          filteredData = filteredData.filter(row => row.location === location);
        }
        
        // Render the filtered table
        renderNotificationsTable(filteredData);
        updateStats();
        
        // Setup sorting after table is rebuilt
        setupSorting();
      }
      
      function filterDeviations(location) {
        if (!window.dashboardData) return;
        
        // Get all deviations
        let filteredData = window.dashboardData.deviations;
        
        // Apply location filter
        if (location !== 'all') {
          filteredData = filteredData.filter(row => row.location === location);
        }
        
        // Render the filtered table
        renderDeviationsTable(filteredData);
        updateStats();
        
        // Setup sorting after table is rebuilt
        setupSorting();
      }
      
      function processData(data) {
        const currentDate = new Date();
        
        // Get all the check-location pairs we need to ensure are shown
        const allChecks = addAllChecks();
        
        // Create a base record template
        const createBaseRecord = (check, location) => ({
          "Date": new Date().toISOString(),
          "Check Location Pairs": `${check} - ${location}`,
          "Check": check,
          "Location": location,
          "Rating": 0,
          "Offense#": "",
          "Warning#": "",
          "DeviationStartDate": "",
          "DeviationEndDate": "",
          "DaysToDeviationEndDate": ""
        });
        
        // Add placeholder records for any missing check-location pairs
        allChecks.forEach(([check, location]) => {
          // Check if this pair exists in the data
          const existingRecord = data.some(record => 
            record["Check"] === check && record["Location"] === location
          );
          
          // If not, add a placeholder record
          if (!existingRecord) {
            data.push(createBaseRecord(check, location));
          }
        });
        
        // Group records by Check and Location
        const groups = {};
        data.forEach(record => {
          let check = record["Check"] || "Unknown";
          let location = record["Location"] || "Unknown";
          let key = check + "|" + location;
          if (!groups[key]) {
            groups[key] = [];
          }
          groups[key].push(record);
        });
        
        const notificationsRows = [];
        const deviationsRows = [];
        const uniqueLocations = new Set();
        let warningsCount = 0;
        
        Object.keys(groups).forEach((key, groupIndex) => {
          const parts = key.split("|");
          const check = parts[0];
          const location = parts[1];
          uniqueLocations.add(location);
          
          const records = groups[key].slice().sort((a, b) => new Date(a["Date"]) - new Date(b["Date"]));
          
          // Find the last warning index
          let lastWarnIndex = -1;
          records.forEach((rec, i) => {
            if (rec["Warning#"] && rec["Warning#"].toString().trim() !== "") {
              lastWarnIndex = i;
            }
          });
          
          let currentCycle = (lastWarnIndex >= 0) ? records.slice(lastWarnIndex + 1) : records.slice();
          if (currentCycle.length === 0) return;
          
          let latest = currentCycle[currentCycle.length - 1];
          let warningLabel = latest["Warning#"] ? latest["Warning#"].toString().trim() : "";
          if (warningLabel) warningsCount++;
          
          // Check for open deviations
          let latestDeviation = null;
          let isOpen = false;
          
          // Find the latest deviation record
          for (let i = records.length - 1; i >= 0; i--) {
            let rec = records[i];
            let warn = rec["Warning#"] ? rec["Warning#"].toString().trim() : "";
            if (warn.startsWith("Dev") && rec["DeviationStartDate"] && rec["DeviationEndDate"]) {
              latestDeviation = rec;
              const startDate = new Date(rec["DeviationStartDate"]);
              const endDate = new Date(rec["DeviationEndDate"]);
              
              // Check if there are any other deviation warnings within the date range
              const hasWarningsInRange = records.some(otherRec => {
                if (otherRec === rec) return false; // Exclude the deviation record itself
                let otherDate = new Date(otherRec["Date"]);
                let otherWarn = otherRec["Warning#"] ? otherRec["Warning#"].toString().trim() : "";
                return (
                  otherWarn.startsWith("Dev") &&
                  otherDate >= startDate &&
                  otherDate <= endDate
                );
              });
              
              isOpen = !hasWarningsInRange;
              break;
            }
          }
          
          if (latestDeviation && isOpen) {
            // Build deviations row for open deviation
            const devEnd = latestDeviation["DeviationEndDate"] || "";
            const endDate = new Date(devEnd);
            
            // Only include deviations where end date is in the future
            if (endDate >= currentDate) {
              const daysRemaining = Math.ceil((endDate - currentDate) / (1000 * 60 * 60 * 24));
              let totalPrevDeviations = records.filter(r => {
                let w = r["Warning#"] ? r["Warning#"].toString().trim() : "";
                return w.startsWith("Dev") && new Date(r["Date"]) < new Date(latestDeviation["Date"]);
              }).length;
              
              deviationsRows.push({
                check: check,
                location: location,
                deviationEnd: devEnd,
                daysRemaining: daysRemaining,
                totalPrevDeviations: totalPrevDeviations,
                locationGroup: getLocationGroup(location)
              });
            }
          } else {
            // Build notifications row
            const notifCount = currentCycle.length;
            let notif1 = notifCount >= 1;
            let notif2 = notifCount >= 2;
            let notif3 = notifCount >= 3;
            let warningDisplay = warningLabel !== "" ? warningLabel : "";
            let totalPrevWarnings = (lastWarnIndex >= 0) ? 
              records.slice(0, lastWarnIndex + 1).filter(r => {
                let w = r["Warning#"] ? r["Warning#"].toString().trim() : "";
                return w && w !== "" && !w.startsWith("Dev");
              }).length : 0;
            
            let notificationsVal = latest["Offense#"] || "";
            
            notificationsRows.push({
              check: check,
              location: location,
              notif1: notif1,
              notif2: notif2,
              notif3: notif3,
              warning: warningDisplay,
              totalPrevWarnings: totalPrevWarnings,
              notifications: notificationsVal,
              notifCount: notifCount,
              hasWarning: warningDisplay !== "",
              locationGroup: getLocationGroup(location)
            });
          }
        });
        
        // Define custom order for location groups (production lines first)
        const groupOrder = {
          'location-lines': 0,
          'location-cz': 1,
          'location-cr': 2,
          'location-areas': 3,
          'location-other': 4,
          'location-forms': 5
        };
        
        // Sort by location group (custom order), then by location, then by check
        notificationsRows.sort((a, b) => {
          // First, sort by location group
          if (a.locationGroup !== b.locationGroup) {
            return groupOrder[a.locationGroup] - groupOrder[b.locationGroup];
          }
          
          // Then, within the same location group, sort by location
          if (a.location !== b.location) {
            return a.location.localeCompare(b.location);
          }
          
          // Finally, within the same location, sort by check
          return a.check.localeCompare(b.check);
        });
        
        deviationsRows.sort((a, b) => {
          // First, sort by location group
          if (a.locationGroup !== b.locationGroup) {
            return groupOrder[a.locationGroup] - groupOrder[b.locationGroup];
          }
          
          // Then, within the same location group, sort by location
          if (a.location !== b.location) {
            return a.location.localeCompare(b.location);
          }
          
          // Finally, within the same location, sort by check
          return a.check.localeCompare(b.check);
        });
        
        // Store the notifications data for toggling views
        window.dashboardData = {
          allNotifications: notificationsRows,
          criticalNotifications: notificationsRows.filter(row => row.notif3 === true),
          deviations: deviationsRows,
          uniqueLocations: uniqueLocations
        };
        
        // Populate location filters with all unique locations
        populateLocationFilters(window.dashboardData);
        
        // Initially show critical notifications (3+)
        renderNotificationsTable(window.dashboardData.criticalNotifications);
        renderDeviationsTable(deviationsRows);
        
        // Update dashboard stats
        updateStats();
      }

      // Fetch the JSON data from data.json
      fetch("data.json")
        .then(response => {
          if (!response.ok) {
            throw new Error("Network response was not ok.");
          }
          return response.json();
        })
        .then(data => {
          processData(data);
          // Set last updated date
          const now = new Date();
          const day = now.getDate().toString().padStart(2, '0');
          const month = now.toLocaleString('en-US', { month: 'short' });
          const year = now.getFullYear();
          const hours = now.getHours().toString().padStart(2, '0');
          const minutes = now.getMinutes().toString().padStart(2, '0');
          document.getElementById("lastUpdated").innerText = `Last updated: ${day} ${month} ${year}, ${hours}:${minutes}`;
          // Setup sorting after tables are populated
          setupSorting();
        })
        .catch(error => {
          console.error("Error fetching data.json:", error);
          document.getElementById("loadingNotifications").innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon"><i class="fas fa-exclamation-triangle"></i></div>
              <div>Failed to load notifications data.</div>
            </div>`;
          document.getElementById("loadingDeviations").innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon"><i class="fas fa-exclamation-triangle"></i></div>
              <div>Failed to load deviations data.</div>
            </div>`;
        });
      
      // Add event listener after DOM is loaded
      document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('fullscreenBtn').addEventListener('click', toggleFullscreen);
        
        // Add event listeners for view toggle buttons
        document.getElementById('viewFilteredBtn').addEventListener('click', function() {
          if (!this.classList.contains('active')) {
            this.classList.add('active');
            document.getElementById('viewAllBtn').classList.remove('active');
            if (window.dashboardData) {
              // Apply both the view filter and location filter
              const locationFilter = document.getElementById('notificationsLocationFilter').value;
              let data = window.dashboardData.criticalNotifications;
              
              if (locationFilter !== 'all') {
                data = data.filter(row => row.location === locationFilter);
              }
              
              renderNotificationsTable(data);
              updateStats();
              setupSorting();
            }
          }
        });
        
        document.getElementById('viewAllBtn').addEventListener('click', function() {
          if (!this.classList.contains('active')) {
            this.classList.add('active');
            document.getElementById('viewFilteredBtn').classList.remove('active');
            if (window.dashboardData) {
              // Apply both the view filter and location filter
              const locationFilter = document.getElementById('notificationsLocationFilter').value;
              let data = window.dashboardData.allNotifications;
              
              if (locationFilter !== 'all') {
                data = data.filter(row => row.location === locationFilter);
              }
              
              renderNotificationsTable(data);
              updateStats();
              setupSorting();
            }
          }
        });
        
        // Handle ESC key to exit fullscreen
        document.addEventListener('fullscreenchange', function() {
          if (!document.fullscreenElement && isFullscreen) {
            // User pressed ESC to exit fullscreen
            toggleFullscreen();
          }
        });
      });
    </script>
  </body>
</html>
