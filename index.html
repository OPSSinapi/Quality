<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Quality Tracker Dashboard</title>
    <style>
      /* General Page Styling */
      body {
        font-family: Arial, sans-serif;
        background: #f8f8f8;
        margin: 20px;
        color: #333;
      }
      h1, h2 {
        text-align: center;
      }
      h2 {
        margin-top: 40px;
      }
      .loading {
        text-align: center;
        margin-top: 20px;
        font-size: 1.2em;
      }

      /* Matrix Grid Styling */
      .matrix {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 1px;
        background: #ccc;
        margin: 20px auto;
        max-width: 1000px;
      }
      .matrix-row {
        display: contents;
      }
      .matrix .cell {
        background: #fff;
        padding: 8px;
        text-align: center;
        border: 1px solid #ddd;
      }
      .matrix.header .cell {
        background: #007acc;
        color: #fff;
        font-weight: bold;
      }
      /* Colour-code groups by location – you might want to adjust these colours. */
      .group-even .cell {
        background: #e7f4ff;
      }
      .group-odd .cell {
        background: #fff;
      }
      .tick {
        font-size: 1.2em;
        color: green;
      }
      .bold {
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <h1>Quality Tracker Dashboard</h1>
    
    <!-- Notifications Matrix Section -->
    <h2>Current Notifications</h2>
    <div id="loadingNotifications" class="loading">Loading notifications...</div>
    <div id="notificationsMatrix" class="matrix" style="display: none;">
      <!-- Header Row -->
      <div class="matrix-row header">
        <div class="cell">Check</div>
        <div class="cell">Location</div>
        <div class="cell">Notification 1</div>
        <div class="cell">Notification 2</div>
        <div class="cell">Notification 3</div>
        <div class="cell">Warning</div>
        <div class="cell">Total Previous Warnings</div>
      </div>
      <!-- Data rows will be injected here -->
    </div>
    
    <!-- Open Deviations Matrix Section -->
    <h2>Open / Current Deviations</h2>
    <div id="loadingDeviations" class="loading">Loading deviations...</div>
    <div id="deviationsMatrix" class="matrix" style="display: none;">
      <!-- Header Row -->
      <div class="matrix-row header">
        <div class="cell">Check</div>
        <div class="cell">Location</div>
        <div class="cell">DeviationEndDate (Days Remaining)</div>
        <div class="cell">Total Previous Deviations</div>
      </div>
      <!-- Data rows will be injected here -->
    </div>
    
    <script>
      // Utility: returns a tick mark (✓) if yes is true, otherwise an empty string.
      function tick(yes) {
        return yes ? "✔" : "";
      }
      
      // Utility: Format date to YYYY-MM-DD
      function formatDate(dateString) {
        if (!dateString) return "";
        const date = new Date(dateString);
        return date.toISOString().split('T')[0];
      }
      
      // Fetch the JSON data from data.json
      fetch("data.json")
        .then(response => {
          if (!response.ok) {
            throw new Error("Network response was not ok.");
          }
          return response.json();
        })
        .then(data => {
          processData(data);
        })
        .catch(error => {
          console.error("Error fetching data.json:", error);
          document.getElementById("loadingNotifications").innerText = "Failed to load notifications data.";
          document.getElementById("loadingDeviations").innerText = "Failed to load deviations data.";
        });
      
      function processData(data) {
        const currentDate = new Date();
        // Group records by Check and Location
        const groups = {};
        data.forEach(record => {
          let check = record["Check"] || "Unknown";
          let location = record["Location"] || "Unknown";
          let key = check + "|" + location;
          if (!groups[key]) {
            groups[key] = [];
          }
          groups[key].push(record);
        });
        
        const notificationsRows = [];
        const deviationsRows = [];
        
        Object.keys(groups).forEach((key, groupIndex) => {
          const parts = key.split("|");
          const check = parts[0];
          const location = parts[1];
          const records = groups[key].slice().sort((a, b) => new Date(a["Date"]) - new Date(b["Date"]));
          
          // Find the last warning index
          let lastWarnIndex = -1;
          records.forEach((rec, i) => {
            if (rec["Warning#"] && rec["Warning#"].toString().trim() !== "") {
              lastWarnIndex = i;
            }
          });
          
          let currentCycle = (lastWarnIndex >= 0) ? records.slice(lastWarnIndex + 1) : records.slice();
          if (currentCycle.length === 0) return;
          
          let latest = currentCycle[currentCycle.length - 1];
          let warningLabel = latest["Warning#"] ? latest["Warning#"].toString().trim() : "";
          
          // Check for open deviations
          let latestDeviation = null;
          let isOpen = false;
          // Find the latest deviation record
          for (let i = records.length - 1; i >= 0; i--) {
            let rec = records[i];
            let warn = rec["Warning#"] ? rec["Warning#"].toString().trim() : "";
            if (warn.startsWith("Dev") && rec["DeviationStartDate"] && rec["DeviationEndDate"]) {
              latestDeviation = rec;
              const startDate = new Date(rec["DeviationStartDate"]);
              const endDate = new Date(rec["DeviationEndDate"]);
              // Check if there are any other deviation warnings within the date range
              const hasWarningsInRange = records.some(otherRec => {
                if (otherRec === rec) return false; // Exclude the deviation record itself
                let otherDate = new Date(otherRec["Date"]);
                let otherWarn = otherRec["Warning#"] ? otherRec["Warning#"].toString().trim() : "";
                return (
                  otherWarn.startsWith("Dev") &&
                  otherDate >= startDate &&
                  otherDate <= endDate
                );
              });
              isOpen = !hasWarningsInRange;
              break;
            }
          }
          
          if (latestDeviation && isOpen) {
            // Build deviations row for open deviation
            const devEnd = formatDate(latestDeviation["DeviationEndDate"]);
            const daysRemaining = Math.ceil((new Date(latestDeviation["DeviationEndDate"]) - currentDate) / (1000 * 60 * 60 * 24));
            let totalPrevDeviations = records.filter(r => {
              let w = r["Warning#"] ? r["Warning#"].toString().trim() : "";
              return w.startsWith("Dev") && new Date(r["Date"]) < new Date(latestDeviation["Date"]);
            }).length;
            deviationsRows.push({
              check: check,
              location: location,
              deviationEnd: devEnd,
              daysRemaining: daysRemaining,
              totalPrevDeviations: totalPrevDeviations
            });
          } else {
            // Build notifications row
            const notifCount = currentCycle.length;
            let notif1 = notifCount >= 1;
            let notif2 = notifCount >= 2;
            let notif3 = notifCount >= 3;
            let warningDisplay = warningLabel !== "" ? `<span class="bold">${warningLabel}</span>` : "";
            let totalPrevWarnings = (lastWarnIndex >= 0) ? 
              records.slice(0, lastWarnIndex + 1).filter(r => {
                let w = r["Warning#"] ? r["Warning#"].toString().trim() : "";
                return w && w !== "" && !w.startsWith("Dev");
              }).length : 0;
            notificationsRows.push({
              check: check,
              location: location,
              notif1: notif1,
              notif2: notif2,
              notif3: notif3,
              warning: warningDisplay,
              totalPrevWarnings: totalPrevWarnings
            });
          }
        });
        
        renderMatrix("notificationsMatrix", notificationsRows, "notifications");
        renderMatrix("deviationsMatrix", deviationsRows, "deviations");
      }
      
      function renderMatrix(containerId, rows, type) {
        const container = document.getElementById(containerId);
        if (!rows || rows.length === 0) {
          document.getElementById(
            containerId === "notificationsMatrix" ? "loadingNotifications" : "loadingDeviations"
          ).innerText = "No data to display.";
          return;
        }
        rows.forEach((row, index) => {
          const rowDiv = document.createElement("div");
          rowDiv.className = "matrix-row " + (index % 2 === 0 ? "group-even" : "group-odd");
          if (type === "notifications") {
            rowDiv.innerHTML = `
              <div class="cell">${row.check}</div>
              <div class="cell">${row.location}</div>
              <div class="cell">${tick(row.notif1)}</div>
              <div class="cell">${tick(row.notif2)}</div>
              <div class="cell">${tick(row.notif3)}</div>
              <div class="cell">${row.warning || ""}</div>
              <div class="cell">${row.totalPrevWarnings}</div>
            `;
          } else if (type === "deviations") {
            rowDiv.innerHTML = `
              <div class="cell">${row.check}</div>
              <div class="cell">${row.location}</div>
              <div class="cell">${row.deviationEnd} (${row.daysRemaining})</div>
              <div class="cell">${row.totalPrevDeviations}</div>
            `;
          }
          container.appendChild(rowDiv);
        });
        container.style.display = "grid";
        if (type === "notifications") {
          document.getElementById("loadingNotifications").style.display = "none";
        } else {
          document.getElementById("loadingDeviations").style.display = "none";
        }
      }
    </script>
  </body>
</html>
