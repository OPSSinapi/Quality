<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Quality Tracker Dashboard</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
      /* Modern, clean styling */
      :root {
        --primary: #3498db;
        --secondary: #2c3e50;
        --success: #2ecc71;
        --warning: #f39c12;
        --danger: #e74c3c;
        --light: #f8f9fa;
        --dark: #343a40;
        --gray: #6c757d;
        --white: #ffffff;

        /* Location group colors */
        --location-lines: #fff8e1; /* Production lines at top */
        --location-cz: #e3f2fd;    /* Change Zone */
        --location-cr: #e8f5e9;    /* Clean Room */
        --location-areas: #f3e5f5;
        --location-other: #fbe9e7;
        --location-forms: #dcedc8;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: var(--light);
        color: var(--dark);
        padding: 1.5rem;
        line-height: 1.5;
        transition: all 0.3s ease;
      }

      .dashboard-container {
        max-width: 1400px;
        margin: 0 auto;
        background: var(--white);
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        transition: all 0.3s ease;
      }
      
      .fullscreen-mode {
        padding: 0;
      }
      
      .fullscreen-mode .dashboard-container {
        max-width: 100%;
        height: 100vh;
        border-radius: 0;
        margin: 0;
      }

      header {
        background: var(--secondary);
        color: var(--white);
        text-align: center;
        padding: 1.5rem;
        position: relative;
      }

      h1 {
        font-size: 1.8rem;
        margin: 0;
      }

      .last-updated {
        position: absolute;
        top: 1rem;
        right: 1rem;
        font-size: 0.8rem;
        opacity: 0.8;
      }
      
      .fullscreen-btn {
        position: absolute;
        top: 1rem;
        left: 1rem;
        background: rgba(255, 255, 255, 0.2);
        color: var(--white);
        border: none;
        border-radius: 4px;
        padding: 0.5rem 1rem;
        font-weight: bold;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.2s ease;
      }
      
      .fullscreen-btn:hover {
        background: rgba(255, 255, 255, 0.3);
      }
      
      .cycling-indicator {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 10px 15px;
        border-radius: 20px;
        z-index: 1000;
        display: none;
      }

      .dashboard-overview {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        padding: 1rem;
        background: var(--light);
      }

      .stat-card {
        background: var(--white);
        border-radius: 8px;
        padding: 1rem;
        text-align: center;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }

      .stat-number {
        font-size: 2rem;
        font-weight: bold;
        color: var(--primary);
      }

      .stat-label {
        font-size: 0.9rem;
        color: var(--gray);
      }

      .dashboard-content {
        display: grid;
        grid-template-columns: 1fr;
        gap: 1.5rem;
        padding: 1.5rem;
      }

      .section {
        margin-bottom: 1rem;
      }

      .section-title {
        font-size: 1.3rem;
        margin-bottom: 1rem;
        color: var(--secondary);
        border-bottom: 2px solid var(--primary);
        padding-bottom: 0.5rem;
      }

      .loading {
        text-align: center;
        padding: 2rem;
        color: var(--gray);
        font-style: italic;
      }

      /* Table styling */
      .responsive-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9rem;
        margin-bottom: 1rem;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      }

      .responsive-table thead {
        background-color: var(--primary);
        color: var(--white);
      }

      .responsive-table thead {
        background-color: var(--primary);
        color: var(--white);
        position: sticky;
        top: 0;
        z-index: 100;
      }

      .responsive-table th {
        padding: 0.75rem 0.5rem;
        text-align: left;
        font-weight: 600;
        background-color: var(--primary);
      }

      .responsive-table td {
        padding: 0.75rem 0.5rem;
        border-bottom: 1px solid rgba(0,0,0,0.05);
      }

      .responsive-table tr:last-child td {
        border-bottom: none;
      }

      /* Location group styling */
      .location-cz td {
        background-color: var(--location-cz);
      }

      .location-cr td {
        background-color: var(--location-cr);
      }

      .location-lines td {
        background-color: var(--location-lines);
      }

      .location-areas td {
        background-color: var(--location-areas);
      }

      .location-other td {
        background-color: var(--location-other);
      }

      .location-forms td {
        background-color: var(--location-forms);
      }

      /* Status indicators */
      .status-indicator {
        display: inline-block;
        width: 15px;
        height: 15px;
        border-radius: 50%;
        margin-right: 4px;
      }

      .status-good {
        background-color: var(--success);
      }

      .status-warning {
        background-color: var(--warning);
      }

      .status-critical {
        background-color: var(--danger);
      }

      .notif-indicator {
        width: 25px;
        height: 25px;
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        color: var(--white);
        font-weight: bold;
        margin: 0 auto;
      }

      .notif-active {
        background-color: var(--primary);
      }

      .notif-inactive {
        background-color: #e0e0e0;
        color: #9e9e9e;
      }

      .warning-badge {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.8rem;
        font-weight: bold;
        background-color: var(--warning);
        color: var(--white);
      }

      .deviation-days {
        font-weight: bold;
      }

      .days-critical {
        color: var(--danger);
      }

      .days-warning {
        color: var(--warning);
      }

      .days-normal {
        color: var(--success);
      }

      /* Make the tables take less height but scrollable */
      .table-container {
        max-height: 400px;
        overflow-y: auto;
        border-radius: 8px;
        border: 1px solid rgba(0,0,0,0.1);
      }

      /* In fullscreen mode, tables take full height */
      .fullscreen-mode .table-container {
        max-height: calc(100vh - 200px);
        flex-grow: 1;
        overflow-y: auto;
      }
      
      /* Make sure table headers work in fullscreen mode */
      .fullscreen-mode .responsive-table thead {
        position: sticky;
        top: 0;
        z-index: 1000;
      }
      
      /* Hide inactive sections when in fullscreen cycling mode */
      .fullscreen-mode .section.inactive {
        display: none;
      }

      /* Legend */
      .legend {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        padding: 1rem;
        background: rgba(0,0,0,0.03);
        border-radius: 8px;
        margin-top: 1rem;
      }

      .legend-item {
        display: flex;
        align-items: center;
        font-size: 0.8rem;
      }

      .legend-color {
        width: 20px;
        height: 20px;
        border-radius: 4px;
        margin-right: 0.5rem;
      }

      /* Responsive adjustments */
      @media (max-width: 768px) {
        .responsive-table {
          font-size: 0.8rem;
        }
        
        .dashboard-content {
          padding: 1rem;
        }
      }

      .icon {
        margin-right: 0.5rem;
      }

      .sortable {
        cursor: pointer;
      }
      
      .sortable:hover {
        background-color: rgba(255,255,255,0.2);
      }

      .sortable::after {
        content: "â‡µ";
        margin-left: 5px;
        opacity: 0.5;
      }
    </style>
  </head>
  <body>
    <div class="dashboard-container">
      <header>
        <h1><i class="fas fa-chart-line icon"></i>Quality Tracker Dashboard</h1>
        <div class="last-updated" id="lastUpdated">Last updated: Loading...</div>
        <button id="fullscreenBtn" class="fullscreen-btn"><i class="fas fa-expand"></i> Fullscreen Mode</button>
      </header>

      <div class="dashboard-overview">
        <div class="stat-card">
          <div class="stat-number" id="totalIssuesCount">-</div>
          <div class="stat-label">Active Issues</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="deviationsCount">-</div>
          <div class="stat-label">Open Deviations</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="locationsCount">-</div>
          <div class="stat-label">Affected Locations</div>
        </div>
      </div>

      <div class="dashboard-content">
        <!-- Notifications Section -->
        <div class="section">
          <h2 class="section-title"><i class="fas fa-bell icon"></i>Current Notifications</h2>
          <div id="loadingNotifications" class="loading">Loading notifications data...</div>
          <div id="notificationsTableContainer" class="table-container" style="display: none;">
            <table id="notificationsTable" class="responsive-table">
              <thead>
                <tr>
                  <th class="sortable" data-sort="check">Check</th>
                  <th class="sortable" data-sort="location">Location</th>
                  <th>Notif 1</th>
                  <th>Notif 2</th>
                  <th>Notif 3</th>
                  <th>Warning</th>
                  <th>Previous Warnings</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
                <!-- Data rows will be injected here -->
              </tbody>
            </table>
          </div>
        </div>

        <!-- Deviations Section -->
        <div class="section">
          <h2 class="section-title"><i class="fas fa-exclamation-triangle icon"></i>Open Deviations</h2>
          <div id="loadingDeviations" class="loading">Loading deviations data...</div>
          <div id="deviationsTableContainer" class="table-container" style="display: none;">
            <table id="deviationsTable" class="responsive-table">
              <thead>
                <tr>
                  <th class="sortable" data-sort="check">Check</th>
                  <th class="sortable" data-sort="location">Location</th>
                  <th class="sortable" data-sort="daysRemaining">End Date (Days Remaining)</th>
                  <th>Previous Deviations</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
                <!-- Data rows will be injected here -->
              </tbody>
            </table>
          </div>
        </div>

        <!-- Legend -->
        <div class="legend">
          <div class="legend-item">
            <div class="legend-color" style="background-color: var(--location-lines);"></div>
            <span>Production Lines (SCD, SUM, LEVO, SCALPEL, POPUP, XL2000/UBT)</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background-color: var(--location-cz);"></div>
            <span>Change Zone (CZ)</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background-color: var(--location-cr);"></div>
            <span>Clean Room (CR)</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background-color: var(--location-areas);"></div>
            <span>General Areas (PO, PA, MH)</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background-color: var(--location-other);"></div>
            <span>Other Locations</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background-color: var(--location-forms);"></div>
            <span>Forms & Registers</span>
          </div>
        </div>
        <div id="cyclingIndicator" class="cycling-indicator">Auto-cycling content...</div>
      </div>
    </div>

    <script>
      // Function to define all check-location pairs for complete coverage
      function addAllChecks() {
        // This array contains all Check-Location pairs that should be tracked
        // Format: [Check, Location]
        return [
          // Production Lines
          // SCD
          ["Overfilling of Feeders", "SCD"],
          ["Components on the floor", "SCD"],
          ["Build-up of subassemblies", "SCD"],
          ["Cluttered workspaces", "SCD"],
          ["Incorrect utilization of containers", "SCD"],
          ["Rework done on the production line", "SCD"],
          ["Cleaning", "SCD"],
          ["More than one component in a bin/container/feeder", "SCD"],
          ["Clear seperation of tested and untested components", "SCD"],
          ["Inadequate or dirty PPE Usage", "SCD"],
          
          // SUM
          ["Overfilling of Feeders", "SUM"],
          ["Components on the floor", "SUM"],
          ["Build-up of subassemblies", "SUM"],
          ["Cluttered workspaces", "SUM"],
          ["Incorrect utilization of containers", "SUM"],
          ["Rework done on the production line", "SUM"],
          ["Cleaning", "SUM"],
          ["More than one component in a bin/container/feeder", "SUM"],
          ["Clear seperation of tested and untested components", "SUM"],
          ["Inadequate or dirty PPE Usage", "SUM"],
          
          // LEVO
          ["Overfilling of Feeders", "LEVO"],
          ["Components on the floor", "LEVO"],
          ["Build-up of subassemblies", "LEVO"],
          ["Cluttered workspaces", "LEVO"],
          ["Incorrect utilization of containers", "LEVO"],
          ["Rework done on the production line", "LEVO"],
          ["Cleaning", "LEVO"],
          ["More than one component in a bin/container/feeder", "LEVO"],
          ["Clear seperation of tested and untested components", "LEVO"],
          ["Inadequate or dirty PPE Usage", "LEVO"],
          
          // SCALPEL
          ["Overfilling of Feeders", "SCALPEL"],
          ["Components on the floor", "SCALPEL"],
          ["Build-up of subassemblies", "SCALPEL"],
          ["Cluttered workspaces", "SCALPEL"],
          ["Incorrect utilization of containers", "SCALPEL"],
          ["Rework done on the production line", "SCALPEL"],
          ["Cleaning", "SCALPEL"],
          ["More than one component in a bin/container/feeder", "SCALPEL"],
          ["Clear seperation of tested and untested components", "SCALPEL"],
          ["Inadequate or dirty PPE Usage", "SCALPEL"],
          
          // POPUP
          ["Overfilling of Feeders", "POPUP"],
          ["Components on the floor", "POPUP"],
          ["Build-up of subassemblies", "POPUP"],
          ["Cluttered workspaces", "POPUP"],
          ["Incorrect utilization of containers", "POPUP"],
          ["Rework done on the production line", "POPUP"],
          ["Cleaning", "POPUP"],
          ["More than one component in a bin/container/feeder", "POPUP"],
          ["Clear seperation of tested and untested components", "POPUP"],
          
          // XL2000/UBT
          ["Overfilling of Feeders", "XL2000/UBT"],
          ["Components on the floor", "XL2000/UBT"],
          ["Build-up of subassemblies", "XL2000/UBT"],
          ["Cluttered workspaces", "XL2000/UBT"],
          ["Incorrect utilization of containers", "XL2000/UBT"],
          ["Rework done on the production line", "XL2000/UBT"],
          ["Cleaning", "XL2000/UBT"],
          ["More than one component in a bin/container/feeder", "XL2000/UBT"],
          ["Clear seperation of tested and untested components", "XL2000/UBT"],
          
          // Areas
          ["Maglocks Not Working", "PO"],
          ["Maglocks Not Working", "PA"],
          ["Maglocks Not Working", "MH"],
          ["Maglocks Not Working", "CZ"],
          ["Hand Soap and Sanitisers Empty", "CZ"],
          ["Hand Soap and Sanitisers Empty", "PO"],
          ["Contaminated Floor Mats", "CR"],
          ["Contaminated Floor Mats", "CZ"],
          ["Contaminated Floor Mats", "PO"],
          
          // Clean Room
          ["Manometer Readings out of Spec: Pressure Differential below 5Pa", "CR"],
          ["Temperature Readings out of Spec: Out of 18-26 deg C range", "CR"],
          ["Air Conditioning Not Maintained at Specified temperatures: 22deg C and cool", "CR"],
          ["AHU Not Functioning: Air Handling unit switched 1 hour before production starts", "CR"],
          ["AHU Not Functioning: Unit only switched off when production is done for the week", "CR"],
          ["Microbial Control in the CR Not maintained based on test results from independant laboratory", "CR"],
          
          // Change Zone
          ["Temperature Readings out of Spec: Out of 18-26 deg C range", "CZ"],
          ["Air Conditioning Not Maintained at Specified temperatures: 22deg C and cool", "CZ"],
          ["AHU Not Functioning: Air Handling unit switched 1 hour before production starts", "CZ"],
          ["AHU Not Functioning: Unit only switched off when production is done for the week", "CZ"],
          ["Cleaning", "CZ"],
          
          // Forms and registers
          ["Maglock Checks", "MF45 REV 00"],
          ["Mat cleaning and solution", "MF49 REV 02"],
          ["Cleaning Checklist", "MF02 REV 09"],
          ["Deep Cleaning Register", "MF54 REV 01"],
          ["Dust Coat Weekly Inspection Register", "MF55 REV 02"],
          ["Glove Issue Register", "MF03 REV 00"],
          ["PPE Register", "MF53 REV 00"],
          ["Earplug Register", "MF91 REV 00"]
        ];
      }

      // Utility functions
      function getLocationGroup(location) {
        // Production line locations (prioritized)
        if (['SCD', 'SUM', 'LEVO', 'Scalpel', 'SCALPEL', 'POPUP', 'XL2000/UBT'].includes(location)) {
          return 'location-lines';
        }
        // Change zone location
        else if (location === 'CZ') {
          return 'location-cz';
        }
        // Clean room location
        else if (location === 'CR') {
          return 'location-cr';
        }
        // Area locations
        else if (['PO', 'PA', 'MH', 'Warehouse', 'Quality'].includes(location)) {
          return 'location-areas';
        }
        // Forms and Registers
        else if (location.includes('REV') || location.startsWith('MF')) {
          return 'location-forms';
        }
        // Default for other locations
        else {
          return 'location-other';
        }
      }

      // Get status based on notification count or days remaining
      function getNotificationStatus(notifCount, hasWarning) {
        if (hasWarning) {
          return 'status-critical';
        } else if (notifCount >= 3) {
          return 'status-warning';
        } else {
          return 'status-good';
        }
      }

      function getDeviationStatus(daysRemaining) {
        if (daysRemaining <= 3) {
          return 'status-critical';
        } else if (daysRemaining <= 7) {
          return 'status-warning';
        } else {
          return 'status-good';
        }
      }

      function getDaysClass(daysRemaining) {
        if (daysRemaining <= 3) {
          return 'days-critical';
        } else if (daysRemaining <= 7) {
          return 'days-warning';
        } else {
          return 'days-normal';
        }
      }

      // Sort functions
      function sortTable(tableId, column, asc = true) {
        const table = document.getElementById(tableId);
        const tbody = table.querySelector('tbody');
        const rows = Array.from(tbody.querySelectorAll('tr'));
        
        // Sort based on the selected column
        const sortedRows = rows.sort((a, b) => {
          const aValue = a.querySelector(`td[data-sort="${column}"]`).getAttribute('data-value');
          const bValue = b.querySelector(`td[data-sort="${column}"]`).getAttribute('data-value');
          
          if (!isNaN(aValue) && !isNaN(bValue)) {
            return asc ? aValue - bValue : bValue - aValue;
          } else {
            return asc ? aValue.localeCompare(bValue) : bValue.localeCompare(aValue);
          }
        });
        
        // Clear table and add sorted rows
        tbody.innerHTML = '';
        sortedRows.forEach(row => tbody.appendChild(row));
      }

      // Attach event listeners to sortable headers
      function setupSorting() {
        document.querySelectorAll('.sortable').forEach(header => {
          header.addEventListener('click', function() {
            const column = this.getAttribute('data-sort');
            const tableId = this.closest('table').id;
            const asc = this.classList.contains('sorted-asc') ? false : true;
            
            // Reset all headers
            document.querySelectorAll('.sortable').forEach(h => {
              h.classList.remove('sorted-asc', 'sorted-desc');
            });
            
            // Set sort indicator
            this.classList.add(asc ? 'sorted-asc' : 'sorted-desc');
            
            sortTable(tableId, column, asc);
          });
        });
      }

      // Fetch the JSON data from data.json
      fetch("data.json")
        .then(response => {
          if (!response.ok) {
            throw new Error("Network response was not ok.");
          }
          return response.json();
        })
        .then(data => {
          processData(data);
          // Set last updated date
          const now = new Date();
          const day = now.getDate().toString().padStart(2, '0');
          const month = now.toLocaleString('en-US', { month: 'short' });
          const year = now.getFullYear();
          const hours = now.getHours().toString().padStart(2, '0');
          const minutes = now.getMinutes().toString().padStart(2, '0');
          document.getElementById("lastUpdated").innerText = `Last updated: ${day} ${month} ${year}, ${hours}:${minutes}`;
          // Setup sorting after tables are populated
          setupSorting();
        })
        .catch(error => {
          console.error("Error fetching data.json:", error);
          document.getElementById("loadingNotifications").innerText = "Failed to load notifications data.";
          document.getElementById("loadingDeviations").innerText = "Failed to load deviations data.";
        });
      
      // Fullscreen and cycling functionality
      let isFullscreen = false;
      let cyclingInterval = null;
      const cycleTime = 10000; // 10 seconds per section
      
      function toggleFullscreen() {
        isFullscreen = !isFullscreen;
        
        if (isFullscreen) {
          // Enter fullscreen
          document.body.classList.add('fullscreen-mode');
          document.getElementById('fullscreenBtn').innerHTML = '<i class="fas fa-compress"></i> Exit Fullscreen';
          
          // Start auto-cycling
          startContentCycling();
          
          // Request browser fullscreen
          if (document.documentElement.requestFullscreen) {
            document.documentElement.requestFullscreen();
          } else if (document.documentElement.webkitRequestFullscreen) {
            document.documentElement.webkitRequestFullscreen();
          } else if (document.documentElement.msRequestFullscreen) {
            document.documentElement.msRequestFullscreen();
          }
        } else {
          // Exit fullscreen
          document.body.classList.remove('fullscreen-mode');
          document.getElementById('fullscreenBtn').innerHTML = '<i class="fas fa-expand"></i> Fullscreen Mode';
          
          // Stop auto-cycling
          stopContentCycling();
          
          // Exit browser fullscreen
          if (document.exitFullscreen) {
            document.exitFullscreen();
          } else if (document.webkitExitFullscreen) {
            document.webkitExitFullscreen();
          } else if (document.msExitFullscreen) {
            document.msExitFullscreen();
          }
        }
      }
      
      function startContentCycling() {
        const sections = [
          { 
            element: document.getElementById('notificationsTableContainer'), 
            parent: document.querySelector('.section:nth-child(1)'),
            title: "Current Notifications"
          },
          { 
            element: document.getElementById('deviationsTableContainer'), 
            parent: document.querySelector('.section:nth-child(2)'),
            title: "Open Deviations"
          }
        ];
        
        let currentSectionIndex = 0;
        let scrollPosition = 0;
        let cycleDuration = 30000; // 30 seconds per table section
        let scrollStep = 1; // pixels per tick
        let cycleTimeout;
        
        document.getElementById('cyclingIndicator').style.display = 'block';
        
        // Show only current section and hide others
        function showCurrentSectionOnly() {
          sections.forEach((section, index) => {
            if (index === currentSectionIndex) {
              section.parent.classList.remove('inactive');
              // Update indicator to show which section is active
              document.getElementById('cyclingIndicator').textContent = 
                `Auto-cycling: ${section.title}`;
            } else {
              section.parent.classList.add('inactive');
            }
          });
        }
        
        // Move to next section
        function nextSection() {
          // Reset scroll position
          if (sections[currentSectionIndex].element) {
            sections[currentSectionIndex].element.scrollTop = 0;
          }
          
          // Move to next section
          currentSectionIndex = (currentSectionIndex + 1) % sections.length;
          scrollPosition = 0;
          
          // Show current section
          showCurrentSectionOnly();
          
          // Start cycling the new section
          startCyclingCurrentSection();
        }
        
        // Function to smoothly scroll the current section
        function startCyclingCurrentSection() {
          const currentSection = sections[currentSectionIndex];
          const scrollContainer = currentSection.element;
          
          if (!scrollContainer) return;
          
          // Reset scroll position
          scrollContainer.scrollTop = 0;
          scrollPosition = 0;
          
          // Clear any existing timeout
          if (cycleTimeout) {
            clearTimeout(cycleTimeout);
          }
          
          // Set up smooth scrolling animation
          const totalHeight = scrollContainer.scrollHeight - scrollContainer.clientHeight;
          let lastTimestamp = null;
          const scrollSpeed = totalHeight / (cycleDuration * 0.8); // px per ms, leaving 20% time for pauses
          
          function smoothScroll(timestamp) {
            if (!lastTimestamp) lastTimestamp = timestamp;
            const elapsed = timestamp - lastTimestamp;
            lastTimestamp = timestamp;
            
            scrollPosition += scrollSpeed * elapsed;
            
            if (scrollPosition >= totalHeight) {
              scrollPosition = totalHeight;
              scrollContainer.scrollTop = scrollPosition;
              
              // Wait at the bottom for a moment before moving to next section
              setTimeout(nextSection, 3000);
              return;
            }
            
            scrollContainer.scrollTop = scrollPosition;
            requestAnimationFrame(smoothScroll);
          }
          
          // Start scrolling animation after a brief pause
          setTimeout(() => {
            requestAnimationFrame(smoothScroll);
          }, 2000);
        }
        
        // Initialize cycling
        showCurrentSectionOnly();
        startCyclingCurrentSection();
      }
      
      function stopContentCycling() {
        if (cyclingInterval) {
          clearInterval(cyclingInterval);
          cyclingInterval = null;
        }
        
        // Remove inactive class from all sections
        document.querySelectorAll('.section').forEach(section => {
          section.classList.remove('inactive');
        });
        
        // Reset scroll positions
        document.getElementById('notificationsTableContainer').scrollTop = 0;
        document.getElementById('deviationsTableContainer').scrollTop = 0;
        
        document.getElementById('cyclingIndicator').style.display = 'none';
      }
      
      // Add event listener after DOM is loaded
      document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('fullscreenBtn').addEventListener('click', toggleFullscreen);
        
        // Handle ESC key to exit fullscreen
        document.addEventListener('fullscreenchange', function() {
          if (!document.fullscreenElement && isFullscreen) {
            // User pressed ESC to exit fullscreen
            toggleFullscreen();
          }
        });
      });
      
      function processData(data) {
        const currentDate = new Date();
        
        // Get all the check-location pairs we need to ensure are shown
        const allChecks = addAllChecks();
        
        // Create a base record template
        const createBaseRecord = (check, location) => ({
          "Date": new Date().toISOString(),
          "Check Location Pairs": `${check} - ${location}`,
          "Check": check,
          "Location": location,
          "Rating": 0,
          "Offense#": "",
          "Warning#": "",
          "DeviationStartDate": "",
          "DeviationEndDate": "",
          "DaysToDeviationEndDate": ""
        });
        
        // Add placeholder records for any missing check-location pairs
        allChecks.forEach(([check, location]) => {
          // Check if this pair exists in the data
          const existingRecord = data.some(record => 
            record["Check"] === check && record["Location"] === location
          );
          
          // If not, add a placeholder record
          if (!existingRecord) {
            data.push(createBaseRecord(check, location));
          }
        });
        
        // Group records by Check and Location
        const groups = {};
        data.forEach(record => {
          let check = record["Check"] || "Unknown";
          let location = record["Location"] || "Unknown";
          let key = check + "|" + location;
          if (!groups[key]) {
            groups[key] = [];
          }
          groups[key].push(record);
        });
        
        const notificationsRows = [];
        const deviationsRows = [];
        const uniqueLocations = new Set();
        let warningsCount = 0;
        
        Object.keys(groups).forEach((key, groupIndex) => {
          const parts = key.split("|");
          const check = parts[0];
          const location = parts[1];
          uniqueLocations.add(location);
          
          const records = groups[key].slice().sort((a, b) => new Date(a["Date"]) - new Date(b["Date"]));
          
          // Find the last warning index
          let lastWarnIndex = -1;
          records.forEach((rec, i) => {
            if (rec["Warning#"] && rec["Warning#"].toString().trim() !== "") {
              lastWarnIndex = i;
            }
          });
          
          let currentCycle = (lastWarnIndex >= 0) ? records.slice(lastWarnIndex + 1) : records.slice();
          if (currentCycle.length === 0) return;
          
          let latest = currentCycle[currentCycle.length - 1];
          let warningLabel = latest["Warning#"] ? latest["Warning#"].toString().trim() : "";
          if (warningLabel) warningsCount++;
          
          // Check for open deviations
          let latestDeviation = null;
          let isOpen = false;
          
          // Find the latest deviation record
          for (let i = records.length - 1; i >= 0; i--) {
            let rec = records[i];
            let warn = rec["Warning#"] ? rec["Warning#"].toString().trim() : "";
            if (warn.startsWith("Dev") && rec["DeviationStartDate"] && rec["DeviationEndDate"]) {
              latestDeviation = rec;
              const startDate = new Date(rec["DeviationStartDate"]);
              const endDate = new Date(rec["DeviationEndDate"]);
              
              // Check if there are any other deviation warnings within the date range
              const hasWarningsInRange = records.some(otherRec => {
                if (otherRec === rec) return false; // Exclude the deviation record itself
                let otherDate = new Date(otherRec["Date"]);
                let otherWarn = otherRec["Warning#"] ? otherRec["Warning#"].toString().trim() : "";
                return (
                  otherWarn.startsWith("Dev") &&
                  otherDate >= startDate &&
                  otherDate <= endDate
                );
              });
              
              isOpen = !hasWarningsInRange;
              break;
            }
          }
          
          if (latestDeviation && isOpen) {
            // Build deviations row for open deviation
            const devEnd = latestDeviation["DeviationEndDate"] || "";
            const endDate = new Date(devEnd);
            
            // Only include deviations where end date is in the future
            if (endDate >= currentDate) {
              const daysRemaining = Math.ceil((endDate - currentDate) / (1000 * 60 * 60 * 24));
              let totalPrevDeviations = records.filter(r => {
                let w = r["Warning#"] ? r["Warning#"].toString().trim() : "";
                return w.startsWith("Dev") && new Date(r["Date"]) < new Date(latestDeviation["Date"]);
              }).length;
              
              deviationsRows.push({
                check: check,
                location: location,
                deviationEnd: devEnd,
                daysRemaining: daysRemaining,
                totalPrevDeviations: totalPrevDeviations,
                locationGroup: getLocationGroup(location)
              });
            }
          } else {
            // Build notifications row
            const notifCount = currentCycle.length;
            let notif1 = notifCount >= 1;
            let notif2 = notifCount >= 2;
            let notif3 = notifCount >= 3;
            let warningDisplay = warningLabel !== "" ? warningLabel : "";
            let totalPrevWarnings = (lastWarnIndex >= 0) ? 
              records.slice(0, lastWarnIndex + 1).filter(r => {
                let w = r["Warning#"] ? r["Warning#"].toString().trim() : "";
                return w && w !== "" && !w.startsWith("Dev");
              }).length : 0;
            
            let notificationsVal = latest["Offense#"] || "";
            
            notificationsRows.push({
              check: check,
              location: location,
              notif1: notif1,
              notif2: notif2,
              notif3: notif3,
              warning: warningDisplay,
              totalPrevWarnings: totalPrevWarnings,
              notifications: notificationsVal,
              notifCount: notifCount,
              hasWarning: warningDisplay !== "",
              locationGroup: getLocationGroup(location)
            });
          }
        });
        
        // Define custom order for location groups (production lines first)
        const groupOrder = {
          'location-lines': 0,
          'location-cz': 1,
          'location-cr': 2,
          'location-areas': 3,
          'location-other': 4,
          'location-forms': 5
        };
        
        // Sort by location group (custom order), then by location, then by check
        notificationsRows.sort((a, b) => {
          // First, sort by location group
          if (a.locationGroup !== b.locationGroup) {
            return groupOrder[a.locationGroup] - groupOrder[b.locationGroup];
          }
          
          // Then, within the same location group, sort by location
          if (a.location !== b.location) {
            return a.location.localeCompare(b.location);
          }
          
          // Finally, within the same location, sort by check
          return a.check.localeCompare(b.check);
        });
        
        deviationsRows.sort((a, b) => {
          // First, sort by location group
          if (a.locationGroup !== b.locationGroup) {
            return groupOrder[a.locationGroup] - groupOrder[b.locationGroup];
          }
          
          // Then, within the same location group, sort by location
          if (a.location !== b.location) {
            return a.location.localeCompare(b.location);
          }
          
          // Finally, within the same location, sort by check
          return a.check.localeCompare(b.check);
        });
        
        // Filter for displaying only notifications with 3 or more offenses
        const filteredNotifications = notificationsRows.filter(row => row.notif3 === true);
        
        renderNotificationsTable(filteredNotifications);
        renderDeviationsTable(deviationsRows);
        
        // Update dashboard stats
        document.getElementById("totalIssuesCount").innerText = filteredNotifications.length + deviationsRows.length;
        document.getElementById("deviationsCount").innerText = deviationsRows.length;
        document.getElementById("locationsCount").innerText = uniqueLocations.size;
      }
      
      function renderNotificationsTable(rows) {
        const tableBody = document.querySelector("#notificationsTable tbody");
        
        // Filter rows to only show entries with 3 or more notifications
        const filteredRows = rows.filter(row => row.notif3 === true);
        
        if (!filteredRows || filteredRows.length === 0) {
          document.getElementById("loadingNotifications").innerText = "No notifications with 3+ offenses to display.";
          return;
        }
        
        filteredRows.forEach(row => {
          const tr = document.createElement("tr");
          tr.className = row.locationGroup;
          
          // Status based on notification count and warning presence
          const statusClass = getNotificationStatus(row.notifCount, row.hasWarning);
          
          tr.innerHTML = `
            <td data-sort="check" data-value="${row.check}">${row.check}</td>
            <td data-sort="location" data-value="${row.location}">${row.location}</td>
            <td class="text-center">
              <div class="notif-indicator ${row.notif1 ? 'notif-active' : 'notif-inactive'}">1</div>
            </td>
            <td class="text-center">
              <div class="notif-indicator ${row.notif2 ? 'notif-active' : 'notif-inactive'}">2</div>
            </td>
            <td class="text-center">
              <div class="notif-indicator ${row.notif3 ? 'notif-active' : 'notif-inactive'}">3</div>
            </td>
            <td>
              ${row.warning ? `<div class="warning-badge">${row.warning}</div>` : ''}
            </td>
            <td>${row.totalPrevWarnings}</td>
            <td>
              <span class="status-indicator ${statusClass}"></span>
            </td>
          `;
          tableBody.appendChild(tr);
        });
        
        document.getElementById("loadingNotifications").style.display = "none";
        document.getElementById("notificationsTableContainer").style.display = "block";
      }
      
      function renderDeviationsTable(rows) {
        const tableBody = document.querySelector("#deviationsTable tbody");
        if (!rows || rows.length === 0) {
          document.getElementById("loadingDeviations").innerText = "No open deviations to display.";
          return;
        }
        
        rows.forEach(row => {
          const tr = document.createElement("tr");
          tr.className = row.locationGroup;
          
          // Format the date as dd MMM
          const endDate = new Date(row.deviationEnd);
          const day = endDate.getDate().toString().padStart(2, '0');
          const month = endDate.toLocaleString('en-US', { month: 'short' });
          const formattedDate = `${day} ${month}`;
          
          // Status based on days remaining
          const statusClass = getDeviationStatus(row.daysRemaining);
          const daysClass = getDaysClass(row.daysRemaining);
          
          tr.innerHTML = `
            <td data-sort="check" data-value="${row.check}">${row.check}</td>
            <td data-sort="location" data-value="${row.location}">${row.location}</td>
            <td data-sort="daysRemaining" data-value="${row.daysRemaining}">
              ${formattedDate} <span class="deviation-days ${daysClass}">(${row.daysRemaining} days)</span>
            </td>
            <td>${row.totalPrevDeviations}</td>
            <td>
              <span class="status-indicator ${statusClass}"></span>
            </td>
          `;
          tableBody.appendChild(tr);
        });
        
        document.getElementById("loadingDeviations").style.display = "none";
        document.getElementById("deviationsTableContainer").style.display = "block";
      }
    </script>
  </body>
</html>
