<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Quality Tracker Dashboard</title>
    <style>
      /* General Page Styling */
      body {
        font-family: Arial, sans-serif;
        background: #f8f8f8;
        margin: 20px;
        color: #333;
      }
      h1, h2 {
        text-align: center;
      }
      h2 {
        margin-top: 40px;
      }
      .loading {
        text-align: center;
        margin-top: 20px;
        font-size: 1.2em;
      }

      /* Matrix Grid Styling */
      .matrix {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 1px;
        background: #ccc;
        margin: 20px auto;
        max-width: 1000px;
      }
      .matrix-row {
        display: contents;
      }
      .matrix .cell {
        background: #fff;
        padding: 8px;
        text-align: center;
        border: 1px solid #ddd;
      }
      .matrix.header .cell {
        background: #007acc;
        color: #fff;
        font-weight: bold;
      }
      /* Colour-code groups by location – you might want to adjust these colours. */
      .group-even .cell {
        background: #e7f4ff;
      }
      .group-odd .cell {
        background: #fff;
      }
      .tick {
        font-size: 1.2em;
        color: green;
      }
      .bold {
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <h1>Quality Tracker Dashboard</h1>
    
    <!-- Notifications Matrix Section -->
    <h2>Current Notifications</h2>
    <div id="loadingNotifications" class="loading">Loading notifications...</div>
    <div id="notificationsMatrix" class="matrix" style="display: none;">
      <!-- Header Row -->
      <div class="matrix-row header">
        <div class="cell">Check</div>
        <div class="cell">Location</div>
        <div class="cell">Notification 1</div>
        <div class="cell">Notification 2</div>
        <div class="cell">Notification 3</div>
        <div class="cell">Warning</div>
        <div class="cell">Total Previous Warnings</div>
        <div class="cell">Notifications</div>
      </div>
      <!-- Data rows will be injected here -->
    </div>
    
    <!-- Open Deviations Matrix Section -->
    <h2>Open / Current Deviations</h2>
    <div id="loadingDeviations" class="loading">Loading deviations...</div>
    <div id="deviationsMatrix" class="matrix" style="display: none;">
      <!-- Header Row -->
      <div class="matrix-row header">
        <div class="cell">Check</div>
        <div class="cell">Location</div>
        <div class="cell">DeviationEndDate (Days Remaining)</div>
        <div class="cell">Total Previous Deviations</div>
        <div class="cell">Status</div>
      </div>
      <!-- Data rows will be injected here -->
    </div>
    
    <script>
      // Utility: returns a tick mark (✓) if yes is true, otherwise an empty string.
      function tick(yes) {
        return yes ? "&#10004;" : "";
      }
      
      // Utility: Check if a date is within a range
      function isDateInRange(date, startDate, endDate) {
        const checkDate = new Date(date);
        const start = new Date(startDate);
        const end = new Date(endDate);
        return checkDate >= start && checkDate <= end;
      }
      
      // Fetch the JSON data from data.json (ensure it is published by GitHub Pages)
      fetch("data.json")
        .then(response => {
          if (!response.ok) {
            throw new Error("Network response was not ok.");
          }
          return response.json();
        })
        .then(data => {
          processData(data);
        })
        .catch(error => {
          console.error("Error fetching data.json:", error);
          document.getElementById("loadingNotifications").innerText = "Failed to load notifications data.";
          document.getElementById("loadingDeviations").innerText = "Failed to load deviations data.";
        });
      
      function processData(data) {
        /* 
          Group records by Check and Location.
          The group key is "Check|Location". Each group is an array of records.
        */
        const groups = {};
        data.forEach(record => {
          // Ensure required fields exist.
          let check = record["Check"] || "Unknown";
          let location = record["Location"] || "Unknown";
          let key = check + "|" + location;
          if (!groups[key]) {
            groups[key] = [];
          }
          groups[key].push(record);
        });
        
        // Prepare arrays for notifications and deviations matrix rows.
        const notificationsRows = [];
        const deviationsRows = [];
        
        // Process each group
        Object.keys(groups).forEach((key, groupIndex) => {
          const parts = key.split("|");
          const check = parts[0];
          const location = parts[1];
          // Sort records by Date (ascending order)
          const records = groups[key].slice().sort((a, b) => new Date(a["Date"]) - new Date(b["Date"]));
          
          // Find the index of the last warning in the group (from previous cycles)
          // Use any record with a nonempty Warning#.
          let lastWarnIndex = -1;
          records.forEach((rec, i) => {
            if (rec["Warning#"] && rec["Warning#"].toString().trim() !== "") {
              lastWarnIndex = i;
            }
          });
          
          // The current cycle consists only of records after the last warning.
          let currentCycle = (lastWarnIndex >= 0) ? records.slice(lastWarnIndex + 1) : records.slice();
          if (currentCycle.length === 0) return; // nothing to show for this group.
          
          // For the Notifications Matrix we count notifications only in current cycle.
          // The latest notification in the current cycle is the one with the maximum date.
          let latest = currentCycle[currentCycle.length - 1];
          
          // Determine which matrix to use:
          // If the latest record's Warning# exists and starts with "Dev", place this group in the Deviations Matrix.
          let warningLabel = latest["Warning#"] ? latest["Warning#"].toString().trim() : "";
          if (warningLabel.startsWith("Dev")) {
            // Build deviations row.
            const devStart = latest["DeviationStartDate"] || "";
            const devEnd = latest["DeviationEndDate"] || "";
            const daysRemaining = latest["DaysToDeviationEndDate"] || "";
            
            // Count previous deviation warnings (from records before the current cycle)
            let totalPrevDeviations = (lastWarnIndex >= 0) ?
              records.slice(0, lastWarnIndex + 1).filter(r => {
                let w = r["Warning#"];
                return w && w.toString().startsWith("Dev");
              }).length : 0;
            
            // Check if deviation is still open
            let isOpen = true;
            if (devStart && devEnd) {
              // Check if there are any Dev warnings within the deviation date range
              isOpen = !records.some(r => 
                r["Warning#"] && 
                r["Warning#"].toString().startsWith("Dev") && 
                r["Date"] && 
                isDateInRange(r["Date"], devStart, devEnd)
              );
            }
            
            deviationsRows.push({
              check: check,
              location: location,
              deviationEnd: devEnd,
              daysRemaining: daysRemaining,
              totalPrevDeviations: totalPrevDeviations,
              status: isOpen ? "Open" : "Closed"
            });
          } else {
            // Build notifications row.
            // Count only notifications in the current cycle (i.e. the number of records in currentCycle)
            const notifCount = currentCycle.length;
            // Ticks for Notification 1, 2, 3 based solely on the current cycle.
            let notif1 = notifCount >= 1;
            let notif2 = notifCount >= 2;
            let notif3 = notifCount >= 3;
            // For Warning, if the latest record has a warning (and it is not a Dev) display it in bold.
            let warningDisplay = warningLabel !== "" ? `<span class="bold">${warningLabel}</span>` : "";
            // Count total previous warnings from earlier cycles (records before currentCycle) that are not deviations.
            let totalPrevWarnings = (lastWarnIndex >= 0) ? 
                records.slice(0, lastWarnIndex + 1).filter(r => {
                  let w = r["Warning#"];
                  return w && w.toString().trim() !== "" && !w.toString().startsWith("Dev");
                }).length : 0;
            // Latest Offense# in current cycle is our Notifications value.
            let notificationsVal = latest["Offense#"] || "";
            notificationsRows.push({
              check: check,
              location: location,
              notif1: notif1,
              notif2: notif2,
              notif3: notif3,
              warning: warningDisplay,
              totalPrevWarnings: totalPrevWarnings,
              notifications: notificationsVal
            });
          }
        });
        
        renderMatrix("notificationsMatrix", notificationsRows, "notifications");
        renderMatrix("deviationsMatrix", deviationsRows, "deviations");
      }
      
      // Renders a matrix grid in the specified containerId.
      // type: "notifications" or "deviations"
      function renderMatrix(containerId, rows, type) {
        const container = document.getElementById(containerId);
        if (!rows || rows.length === 0) {
          document.getElementById(
            containerId === "notificationsMatrix" ? "loadingNotifications" : "loadingDeviations"
          ).innerText = "No data to display.";
          return;
        }
        // For each row, create a grid row div.
        // Alternate background for grouping (using odd/even group index).
        rows.forEach((row, index) => {
          const rowDiv = document.createElement("div");
          rowDiv.className = "matrix-row " + (index % 2 === 0 ? "group-even" : "group-odd");
          if (type === "notifications") {
            // Columns: Check, Location, Notification 1, Notification 2, Notification 3, Warning, Total Previous Warnings, Notifications
            rowDiv.innerHTML = `
              <div class="cell">${row.check}</div>
              <div class="cell">${row.location}</div>
              <div class="cell">${tick(row.notif1)}</div>
              <div class="cell">${tick(row.notif2)}</div>
              <div class="cell">${tick(row.notif3)}</div>
              <div class="cell">${row.warning || ""}</div>
              <div class="cell">${row.totalPrevWarnings}</div>
              <div class="cell">${row.notifications}</div>
            `;
          } else if (type === "deviations") {
            // Columns: Check, Location, DeviationEndDate (Days Remaining), Total Previous Deviations, Status
            rowDiv.innerHTML = `
              <div class="cell">${row.check}</div>
              <div class="cell">${row.location}</div>
              <div class="cell">${row.deviationEnd} (${row.daysRemaining})</div>
              <div class="cell">${row.totalPrevDeviations}</div>
              <div class="cell">${row.status}</div>
            `;
          }
          container.appendChild(rowDiv);
        });
        container.style.display = "grid";
        if (type === "notifications") {
          document.getElementById("loadingNotifications").style.display = "none";
        } else {
          document.getElementById("loadingDeviations").style.display = "none";
        }
      }
    </script>
  </body>
</html>
